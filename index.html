<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Coin">
    <title>Challenge Coin!</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #ff6098;
            --color-primary-light: #ff6b9d;
            --color-primary-pale: #fff0f5;
            --color-primary-border: #ffc8d9;
            --color-gradient-start: #dae7f8;
            --color-gradient-end: #fde5f0;
            --color-bg-gradient-start: #ffd5cd;
            --color-bg-gradient-end: #ffb4a8;
            --color-green: #4caf50;
            --color-green-light: #81c784;
            --color-green-bg: #e6f7e9;
            --color-red: #c62828;
            --color-red-light: #ffebee;
            --color-red-border: #ffcdd2;
            --color-orange: #e65100;
            --color-orange-bg: #fff4e6;
            --color-yellow-bg: #fffacd;
            --color-cyan-bg: #e0f7fa;
            --color-blue-bg: #e6faff;
            --color-text: #333;
            --color-text-light: #666;
            --color-text-lighter: #999;
            --color-border: #e9ecef;
            --color-border-light: #f8f9fa;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 10px 40px rgba(0, 0, 0, 0.2);
            --radius-sm: 10px;
            --radius-md: 15px;
            --radius-lg: 20px;
            --radius-xl: 25px;
            --radius-xxl: 40px;
        }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    body {
        font-family: 'M PLUS Rounded 1c', 'Varela Round', sans-serif;
        background: linear-gradient(135deg, var(--color-bg-gradient-start) 0%, var(--color-bg-gradient-end) 100%);
        min-height: 100vh;
        padding: 20px;
        touch-action: manipulation;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .container {
        max-width: 1200px;
        width: 100%;
        height: 95vh;
        margin: 0 auto;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
    }

    .header {
        background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
        padding: 30px;
        text-align: center;
        position: relative;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        flex-shrink: 0;
    }

    .header h1 {
        font-size: 36px;
        font-weight: 800;
        color: var(--color-primary);
        letter-spacing: 1px;
        text-shadow: 2px 2px 8px rgba(255, 96, 152, 0.3);
    }

    .header-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        transition: background 0.2s;
    }

    .header-btn:hover {
        background: var(--color-yellow-bg);
    }

    .header-btn svg {
        width: 24px;
        height: 24px;
        fill: rgba(0, 0, 0, 0.4);
    }

    .back-btn { left: 30px; }
    .settings-btn { right: 30px; }
    
    .challenge-buttons-container {
    padding: 0px 0px 0px 0px;
    transition: padding-left 0.3s ease;
    position: sticky;
    top: 0;
    background: transparent;
    z-index: 10;
    flex-shrink: 0;
    }
    
    .challenge-buttons-container.scrolled {
    padding-left: 0; /* スクロール時に左余白を削除 */
    }
    
    .challenge-buttons-wrapper {
    display: flex;
    gap: 10px; /* ボタン間のスペース */
    padding: 20px 40px 20px 40px; 
    flex-grow: 1;
    overflow-x: auto;
    position: relative;
    }

    .challenge-buttons-container::-webkit-scrollbar {
        display: none;
    }

    .challenge-button {
        background: white;
        color: var(--color-text-lighter);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-xl);
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        flex-shrink: 0;
        transition: transform 0.2s, background 0.2s, color 0.2s;
        white-space: nowrap;
        min-height: 44px;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
    }

    .challenge-button:active {
        transform: scale(0.98);
    }

    .challenge-button.active {
        background: var(--color-primary-pale);
        color: #e91e63;
        border-color: var(--color-primary-border);
    }

    .content {
        padding: 0px;
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        position: relative;
    }

    .content::after {
        content: '';
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, transparent, white);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .content.has-scroll::after {
        opacity: 1;
    }

    .screen {
        display: none;
        flex: 1;
        overflow-y: auto;
    }

    .screen.active {
        display: flex;
        flex-direction: column;
    }

    .screen-content {
        padding: 0px 40px 0px 40px;
        flex: 1;
    }

    .account-list {
        display: flex;
        flex-direction: column;
        gap: 25px;
        flex: 1;
        justify-content: flex-start;
        padding: 40px;
    }

    .account-list-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: var(--color-text-lighter);
        font-size: 20px;
        line-height: 1.6;
    }

    .account-card {
        background: var(--color-cyan-bg);
        border-radius: clamp(20px, 5vw, 40px);
        padding: 20px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 60px;
        flex: 1;
        border: 2px solid #cceffa;
    }

    .account-card:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .account-list:has(.account-card:only-of-type) .account-card {
        flex: 0 1 auto;
        min-height: 200px;
    }

    .account-card h3 {
        font-size: clamp(22px, 4vw, 32px);
        color: var(--color-text);
    }

    .coins-info {
        display: flex;
        align-items: baseline;
        gap: 5px;
    }

    .coins-number-list {
        font-size: 44px;
        font-weight: bold;
        color: var(--color-primary-light);
    }

    .add-account-btn {
        background-color: var(--color-green-bg);
        border: 2px dashed var(--color-green-light);
        border-radius: var(--radius-xxl);
        padding: 20px 20px;
        cursor: pointer;
        text-align: center;
        font-size: 22px;
        color: var(--color-green);
        font-weight: bold;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
    }

    .add-account-btn:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .add-account-btn.hidden {
        display: none;
    }

    .coins-display {
        background: var(--color-blue-bg);
        border-radius: var(--radius-md);
        padding: 40px 30px;
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .coins-display-content {
        width: 100%;
    }

    .coins-display.empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .coins-display.empty-state .coins-display-content {
        display: none;
    }

    .empty-state-message {
        font-size: 18px;
        color: var(--color-text-light);
        display: none;
    }

    .coins-display.empty-state .empty-state-message {
        display: block;
    }

    .coin-value-label {
        display: block;
        width: fit-content;
        margin: 0 auto 10px;
        font-size: 18px;
        color: var(--color-text-light);
        background: var(--color-primary-pale);
        padding: 8px 15px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-primary-border);
    }

    .coin-value-label strong {
        color: var(--color-primary-light);
    }

    .coins-label {
        font-size: 20px;
        color: var(--color-text-light);
        margin-bottom: 15px;
    }

    .coins-main {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }

    .coins-number {
        font-size: 80px;
        font-weight: bold;
        color: var(--color-primary-light);
        min-width: 120px;
    }

    .coins-number.disabled {
        color: #ccc;
    }

    .coin-btn {
        width: 60px;
        height: 60px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
    }

    .coin-btn svg {
        display: block;
        margin: auto;
    }

    .coin-btn:active {
        transform: scale(0.95);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .coin-btn:disabled {
        background: #eee !important;
        color: #ccc !important;
        cursor: not-allowed;
        box-shadow: none;
    }

    .coin-btn-add {
        background: #a8e6cf;
        color: var(--color-text);
    }

    .coin-btn-minus {
        background: #ffb3ba;
        color: var(--color-text);
    }

    .coins-value {
        font-size: 28px;
        color: var(--color-text);
        font-weight: bold;
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .total-coins {
        display: none;
    }

    .exchange-section {
        background: var(--color-yellow-bg);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 20px;
    }

    .exchange-section h3 {
        font-size: 20px;
        color: var(--color-text);
        margin-bottom: 15px;
        font-weight: bold;
    }

    .exchange-input {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    .exchange-input input {
        flex: 1;
        padding: 15px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-sm);
        font-size: 20px;
        text-align: center;
        font-family: inherit;
        min-height: 52px;
    }

    .exchange-input span {
        font-size: 18px;
        color: #555;
    }

    .btn-exchange {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
        border: 1px solid rgba(255, 153, 187, 0.15);
        border-radius: var(--radius-sm);
        font-size: 20px;
        font-weight: bold;
        color: var(--color-text);
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 52px;
    }

    .btn-exchange:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-exchange:disabled {
        background: #eee;
        color: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        border: 2px solid #e9ecef;
    }

    .history-compact {
        background: white;
        border-radius: var(--radius-md);
        padding: 20px;
        border: 2px solid var(--color-border);
    }

    .history-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .history-total-label {
        font-size: 16px;
        color: var(--color-text-lighter);
    }

    .history-total-amount {
        font-size: 28px;
        font-weight: bold;
        color: var(--color-primary-light);
    }

    .btn-show-history {
        padding: 12px 20px;
        background: var(--color-yellow-bg);
        border: 1.5px solid #f0e68c;
        border-radius: var(--radius-sm);
        font-size: 16px;
        color: var(--color-text-light);
        cursor: pointer;
        font-family: inherit;
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 44px;
        width: 140px;
        flex-shrink: 0;
        box-shadow: var(--shadow-sm);
    }

    .btn-show-history:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .history-details {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid var(--color-border-light);
        display: none;
    }

    .history-details.show {
        display: block;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        border-bottom: 1px solid var(--color-border-light);
        font-size: 15px;
        gap: 10px;
    }

    .history-description {
        font-weight: bold;
        color: #555;
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .history-challenge-badge {
        display: inline-block;
        background: var(--color-primary-pale);
        color: var(--color-primary-light);
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid var(--color-primary-border);
    }

    .history-date {
        color: var(--color-text-lighter);
        font-size: 13px;
    }

    .history-reward-amount {
        color: var(--color-primary-light);
        font-weight: bold;
    }

    .history-empty {
        text-align: center;
        color: var(--color-text-lighter);
        padding: 20px;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 30px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-header h2 {
        font-size: 26px;
        color: var(--color-text);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 32px;
        cursor: pointer;
        color: var(--color-text-lighter);
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .setting-section {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 2px solid var(--color-border-light);
    }

    .setting-section:last-child {
        border-bottom: none;
    }

    .setting-section h3 {
        font-size: 20px;
        color: var(--color-text);
        margin-bottom: 15px;
        font-weight: bold;
    }

    .account-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .account-item input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-sm);
        font-size: 18px;
        font-family: inherit;
        min-height: 48px;
        min-width: 0;
    }

    .btn-delete-account {
        padding: 12px 12px;
        background: var(--color-red-light);
        border: 2px solid var(--color-red-border);
        border-radius: var(--radius-sm);
        color: var(--color-red);
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
    }

    .btn-delete-account:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-delete-account svg {
        width: 20px;
        height: 20px;
        fill: var(--color-red);
        display: block;
    }

    .challenge-item {
        background: var(--color-border-light);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 15px;
    }

    .challenge-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .challenge-header h4 {
        font-size: 18px;
    }

    .challenge-inputs-group {
        margin-bottom: 15px;
    }

    .challenge-inputs-group label {
        display: block;
        font-size: 15px;
        color: var(--color-text-lighter);
        margin-bottom: 5px;
    }

    .challenge-inputs-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-sm);
        font-size: 18px;
        font-family: inherit;
        min-height: 48px;
    }

    .challenge-value-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .input-with-suffix {
        flex-grow: 1;
        position: relative;
    }

    .input-with-suffix input {
        width: 100%;
        text-align: right;
        padding-right: 45px;
    }

    .input-with-suffix .suffix {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        color: var(--color-text-light);
        pointer-events: none;
    }

    .btn-delete-challenge {
        padding: 12px 12px;
        background: var(--color-red-light);
        border: 2px solid var(--color-red-border);
        border-radius: 8px;
        color: var(--color-red);
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 44px;
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-delete-challenge:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-delete-challenge svg {
        width: 20px;
        height: 20px;
        fill: var(--color-red);
        display: block;
    }

    .btn-add {
        background-color: var(--color-green-bg);
        border: 2px dashed var(--color-green-light);
        border-radius: var(--radius-sm);
        color: var(--color-green);
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        padding: 15px;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 16px;
        min-height: 52px;
    }

    .btn-add:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-add.hidden {
        display: none;
    }

    .btn-save {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
        border: 1px solid rgba(255, 153, 187, 0.15);
        border-radius: var(--radius-sm);
        font-size: 20px;
        font-weight: bold;
        color: var(--color-text);
        cursor: pointer;
        margin-bottom: 20px;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        min-height: 52px;
    }

    .btn-save:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .reset-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .btn-reset {
        padding: 15px;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: bold;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 16px;
        min-height: 52px;
    }

    .btn-reset:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-reset-all {
        background: var(--color-red-light);
        color: var(--color-red);
        border: 2px solid var(--color-red-border);
    }

    .btn-reset-child {
        background: var(--color-orange-bg);
        color: var(--color-orange);
        border: 2px solid #ffcc80;
    }

    .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .confirm-modal.show {
        display: flex;
    }

    .confirm-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: 30px;
        max-width: 400px;
        width: 100%;
        text-align: center;
    }

    .confirm-content h3 {
        font-size: 22px;
        margin-bottom: 15px;
    }

    .confirm-content p {
        color: var(--color-text-light);
        margin-bottom: 25px;
        font-size: 16px;
        line-height: 1.5;
    }

    .confirm-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-confirm {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: var(--radius-sm);
        font-weight: bold;
        cursor: pointer;
        font-family: inherit;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 16px;
        min-height: 52px;
    }

    .btn-confirm:active {
        transform: scale(0.98);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .btn-cancel {
        background: var(--color-border);
        color: var(--color-text);
    }

    .btn-confirm-action {
        background: #e57373;
        color: white;
        border: 1px solid var(--color-red);
    }

    .exchange-confirm {
        background: linear-gradient(135deg, var(--color-gradient-start) 0%, var(--color-gradient-end) 100%);
        color: var(--color-text) !important;
        border: 1px solid var(--color-primary-border) !important;
    }

    .celebration {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: clamp(30px, 8vw, 50px);
        border-radius: var(--radius-lg);
        text-align: center;
        z-index: 1002;
        display: none;
        box-shadow: var(--shadow-xl);
        max-width: 90%;
    }

    .celebration.show {
        display: block;
    }

    .celebration h2 {
        font-size: clamp(24px, 7vw, 40px);
        color: var(--color-primary-light);
        margin-bottom: clamp(15px, 3vw, 20px);
    }

    .celebration p {
        font-size: clamp(16px, 3.5vw, 20px);
    }

    .celebration-amount {
        color: var(--color-primary-light);
        font-weight: 800;
        font-size: 1.2em;
    }

    .confetti {
        position: fixed;
        width: 12px;
        height: 12px;
        z-index: 1001;
    }
    .challenge-buttons-wrapper.scrolling {
        padding-left: 0px;;
    }

    @keyframes confetti-fall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    .celebration {
    z-index: 1002; 
    }
    
    .overlay.show {
        display: block;
    }

    @media (max-width: 768px) {
        body { padding: 10px; }
        .header { padding: 20px 15px; }
        .header h1 { font-size: 28px; }
        .back-btn { left: 20px; }
        .settings-btn { right: 20px; }
        .content { padding: 0px; }
        .challenge-buttons-container { padding: 15px 0px 15px 20px; }
        .screen-content { padding: 0px 30px 30px 30px; }
        .account-list { padding: 30px; }
        .account-list-empty { font-size: 18px; }
        .coins-display { padding: 35px 20px; min-height: 180px; }
        .coins-number { font-size: 64px; min-width: 100px; }
    }

    @media (max-width: 480px) {
        .header h1 { font-size: 24px; }
        .content { padding: 0px; }
        .challenge-buttons-container { padding: 15px 0px 15px 20px; }
        .screen-content { padding: 0px 20px 20px 20px; }
        .account-list { padding: 20px; }
        .coins-display { padding: 30px 20px; min-height: 160px; }
        .coins-number { font-size: 52px; min-width: 80px; }
        .exchange-input {
            flex-direction: column;
            align-items: stretch;
        }
    }

    @media (min-width: 768px) {
        .container {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        .coins-number {
            font-size: 96px;
        }
        
        .coin-btn {
            width: 70px;
            height: 70px;
            font-size: 32px;
        }
    }
</style>

</head>
<body>
    <div class="container">
        <div class="header">
            <button class="header-btn back-btn" id="backBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
                </svg>
            </button>
            <h1 id="headerTitle">Challenge Coin!</h1>
            <button class="header-btn settings-btn" id="globalSettingsBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
            <button class="header-btn settings-btn" id="detailSettingsBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
        </div>

    <div class="content">
        <div class="screen active" id="accountSelectScreen">
            <div class="account-list" id="accountList"></div>
        </div>

        <div class="screen" id="accountDetailScreen">
            <div class="challenge-buttons-container" id="challengeButtonsContainer">
                <div class="challenge-buttons-wrapper" id="challengeButtonsWrapper"></div>
            </div>
            <div class="screen-content" id="detailScreenContent">
                <div class="coins-display" id="coinsDisplay">
                    <div class="empty-state-message">設定からチャレンジを追加してください。</div>
                    <div class="coins-display-content">
                        <div class="coin-value-label" id="coinValueLabel"></div>
                        <div class="coins-label">現在のコイン</div>
                        <div class="coins-main">
                            <button class="coin-btn coin-btn-minus" id="removeCoinBtn">−</button>
                            <div class="coins-number" id="currentCoins">0</div>
                            <button class="coin-btn coin-btn-add" id="addCoinBtn">+</button>
                        </div>
                        <div class="coins-value">
                            = <span id="currentValue">0</span>円
                        </div>
                        <div class="total-coins">
                            <span id="totalCoinsLabel">これまでのコイン合計</span>: 
                            <span class="total-coins-number" id="totalCoins">0</span>コイン
                        </div>
                    </div>
                </div>

                <div class="exchange-section">
                    <h3>コインの交換</h3>
                    <div class="exchange-input">
                        <input type="number" id="exchangeInput" min="1" value="1">
                        <span>コイン</span>
                    </div>
                    <button class="btn-exchange" id="exchangeBtn">おこづかいと交換する</button>
                </div>

                <div class="history-compact">
                    <div class="history-summary">
                        <div class="history-total">
                            <div class="history-total-label">おこづかい合計</div>
                            <div class="history-total-amount" id="totalReward">0円</div>
                        </div>
                        <button class="btn-show-history" id="toggleHistoryBtn">
                            <span id="historyToggleText">くわしく見る</span>
                        </button>
                    </div>
                    <div class="history-details" id="historyDetails">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="globalSettingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>全体設定</h2>
            <button class="close-btn" id="closeGlobalSettingsBtn">×</button>
        </div>
        <div class="setting-section">
            <h3>アカウント管理</h3>
            <p style="color: #999; font-size: 14px; margin-bottom: 15px;">3人まで登録できます</p>
            <div id="accountSettings"></div>
            <button class="btn-add" id="addAccountBtn">＋ アカウントを追加</button>
        </div>
        <div class="setting-section">
            <h3>データのリセット</h3>
            <div class="reset-buttons">
                <button class="btn-reset btn-reset-all" id="resetAllBtn">全データをリセット</button>
            </div>
        </div>
        <button class="btn-save" id="saveGlobalSettingsBtn">保存</button>
    </div>
</div>

<div class="modal" id="detailSettingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="detailModalTitle">アカウント設定</h2>
            <button class="close-btn" id="closeDetailSettingsBtn">×</button>
        </div>
        <div class="setting-section">
            <h3>アカウント名</h3>
            <div class="account-item">
                <input type="text" id="detailAccountNameInput">
            </div>
        </div>
        <div class="setting-section">
            <h3>チャレンジ管理</h3>
            <div id="detailChallengeSettings"></div>
            <button class="btn-add" id="addChallengeInDetailModalBtn">＋ チャレンジを追加</button>
        </div>
        <button class="btn-save" id="saveDetailSettingsBtn">保存</button>
        <div class="setting-section">
            <h3>データのリセット</h3>
            <div class="reset-buttons">
                <button class="btn-reset btn-reset-child" id="resetCurrentBtn">このアカウントをリセット</button>
            </div>
        </div>
    </div>
</div>

<div class="confirm-modal" id="confirmModal">
    <div class="confirm-content">
        <h3 id="confirmTitle">確認</h3>
        <p id="confirmMessage"></p>
        <div class="confirm-buttons">
            <button class="btn-confirm btn-cancel" id="cancelBtn">キャンセル</button>
            <button class="btn-confirm btn-confirm-action" id="confirmActionBtn">はい</button>
        </div>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="celebration" id="celebration">
    <h2>がんばったね!</h2>
    <p id="celebrationText"></p>
</div>

<script>
    const CONFIG = {
        MAX_ACCOUNTS: 3,
        STORAGE_KEY: 'challengeCoinData',
        DEFAULT_CHALLENGE: { name: 'お手伝い', value: 10, coins: 0, totalCoins: 0 },
        CELEBRATION_DURATION: 3000,
        CONFETTI_COUNT: 50,
        CONFETTI_COLORS: ['#ff6b9d', '#ffb3ba', '#a8e6cf', '#dae7f8']
    };

    const StorageAdapter = {
        save(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error('保存エラー:', e);
            }
        },
        load(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('読み込みエラー:', e);
                return null;
            }
        },
        remove(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('削除エラー:', e);
            }
        }
    };

    const state = {
        appData: { accounts: [] },
        currentAccountIndex: -1,
        currentChallengeIndex: 0,
        confirmCallback: null
    };

    const Utils = {
        $(id) {
            return document.getElementById(id);
        },

        formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('ja-JP', {
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },

        validateChallengeValue(value) {
            return (typeof value === 'number' && value >= 1) ? value : 10;
        },

        sanitizeAccountName(name, fallback) {
            return (name && name.trim()) || fallback;
        }
    };

    const DataManager = {
        save() {
            StorageAdapter.save(CONFIG.STORAGE_KEY, state.appData);
        },

        load() {
            const saved = StorageAdapter.load(CONFIG.STORAGE_KEY);
            if (saved && Array.isArray(saved.accounts)) {
                this.migrateData(saved);
                state.appData = saved;
                return;
            }

            this.createDefaultData();
        },

        migrateData(data) {
            data.accounts.forEach(acc => {
                if (!acc.challenges) acc.challenges = [];
                if (!acc.history) acc.history = [];
                
                if (typeof acc.coins === 'number') {
                    if (acc.challenges.length === 0) {
                        acc.challenges.push({ ...CONFIG.DEFAULT_CHALLENGE });
                    }
                    if (acc.challenges.length > 0) {
                        acc.challenges[0].coins = acc.coins;
                    }
                    delete acc.coins;
                }
                
                acc.challenges.forEach(chal => {
                    if (typeof chal.coins !== 'number') chal.coins = 0;
                    if (typeof chal.totalCoins !== 'number') chal.totalCoins = 0;
                    chal.value = Utils.validateChallengeValue(chal.value);
                });
            });
        },

        createDefaultData() {
            state.appData = {
                accounts: [{
                    name: "なまえ",
                    challenges: [],
                    history: []
                }]
            };
            this.save();
        },

        reset() {
            StorageAdapter.remove(CONFIG.STORAGE_KEY);
            this.load();
        }
    };

    const AccountManager = {
        getCurrentAccount() {
            return state.appData.accounts[state.currentAccountIndex];
        },

        getCurrentChallenge() {
            const account = this.getCurrentAccount();
            return account?.challenges[state.currentChallengeIndex];
        },

        getTotalCoins(account) {
            return account.challenges.reduce((sum, chal) => sum + chal.coins, 0);
        },

        getTotalReward(account) {
            return account.history.reduce((sum, item) => sum + item.reward, 0);
        },

        addAccount() {
            if (state.appData.accounts.length < CONFIG.MAX_ACCOUNTS) {
                state.appData.accounts.push({
                    name: `アカウント ${state.appData.accounts.length + 1}`,
                    challenges: [],
                    history: []
                });
                DataManager.save();
                return true;
            }
            return false;
        },

        deleteAccount(index) {
            state.appData.accounts.splice(index, 1);
            DataManager.save();
            if (state.currentAccountIndex === index) {
                state.currentAccountIndex = -1;
            }
        },

        addChallenge(account) {
            account.challenges.push({
                name: '新しいチャレンジ',
                value: 10,
                coins: 0,
                totalCoins: 0
            });
        },

        deleteChallenge(account, index) {
            account.challenges.splice(index, 1);
            if (state.currentChallengeIndex >= account.challenges.length) {
                state.currentChallengeIndex = Math.max(0, account.challenges.length - 1);
            }
        },

        resetAccount(account) {
            account.challenges.forEach(chal => {
                chal.coins = 0;
                chal.totalCoins = 0;
            });
            account.history = [];
            DataManager.save();
        }
    };

    const CoinManager = {
        addCoin() {
            const challenge = AccountManager.getCurrentChallenge();
            if (!challenge) return;

            challenge.coins += 1;
            challenge.totalCoins += 1;
            DataManager.save();
            UIManager.renderCoinDisplay();
            
            CelebrationManager.show('頑張ったね!', '+1 コイン');
        },

        removeCoin() {
            const challenge = AccountManager.getCurrentChallenge();
            if (!challenge || challenge.coins <= 0) return;

            challenge.coins -= 1;
            challenge.totalCoins -= 1;
            DataManager.save();
            UIManager.renderCoinDisplay();
        },

        exchange(amount) {
            const account = AccountManager.getCurrentAccount();
            const challenge = AccountManager.getCurrentChallenge();
            
            if (!challenge || amount <= 0 || amount > challenge.coins) return;

            const reward = amount * challenge.value;
            challenge.coins -= amount;
            
            account.history.push({
                type: 'exchange',
                coins: amount,
                reward: reward,
                challengeName: challenge.name,
                timestamp: Date.now()
            });

            DataManager.save();
            UIManager.renderDetailScreen();
            
            CelebrationManager.show(
                'おめでとう!',
                `${amount}コインを ${reward.toLocaleString()}円 に交換しました!`
            );
        }
    };

    const UIManager = {
        showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            Utils.$(screenId).classList.add('active');

            const isDetail = screenId === 'accountDetailScreen';
            Utils.$('backBtn').style.display = isDetail ? 'flex' : 'none';
            Utils.$('globalSettingsBtn').style.display = !isDetail ? 'flex' : 'none';
            Utils.$('detailSettingsBtn').style.display = isDetail ? 'flex' : 'none';
            Utils.$('challengeButtonsContainer').style.display = isDetail ? 'flex' : 'none';

            if (isDetail) {
                this.renderDetailScreen();
                this.setupScrollHandler();
            } else {
                Utils.$('headerTitle').textContent = 'Challenge Coin!';
                this.renderAccountSelectScreen();
                this.removeScrollHandler();
            }
        },

        setupScrollHandler() {
            const screen = Utils.$('accountDetailScreen');
            const buttonsContainer = Utils.$('challengeButtonsContainer');
            
            if (screen && buttonsContainer) {
                screen.addEventListener('scroll', this.handleScroll);
            }
        },

        removeScrollHandler() {
            const screen = Utils.$('accountDetailScreen');
            if (screen) {
                screen.removeEventListener('scroll', this.handleScroll);
            }
        },

        handleScroll() {
            const screen = Utils.$('accountDetailScreen');
            const buttonsContainer = Utils.$('challengeButtonsContainer');
            
            if (screen && buttonsContainer) {
                if (screen.scrollTop > 10) {
                    buttonsContainer.classList.add('floating');
                } else {
                    buttonsContainer.classList.remove('floating');
                }
            }
        },

        renderAccountSelectScreen() {
            const list = Utils.$('accountList');
            list.innerHTML = '';
            
            if (state.appData.accounts.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #999; padding: 30px;">
                    アカウントがありません。<br>設定から追加してください。
                </div>`;
                return;
            }

            state.appData.accounts.forEach((account, index) => {
                const card = this.createAccountCard(account, index);
                list.appendChild(card);
            });
        },

        createAccountCard(account, index) {
            const card = document.createElement('div');
            card.classList.add('account-card');
            card.dataset.index = index;
            
            const currentCoins = AccountManager.getTotalCoins(account);

            card.innerHTML = `
                <h3>${account.name}</h3>
                <div class="coins-info">
                    <span class="coins-number-list">${currentCoins}</span>
                    <span>コイン</span>
                </div>
            `;
            
            card.addEventListener('click', () => {
                state.currentAccountIndex = index;
                state.currentChallengeIndex = 0;
                this.showScreen('accountDetailScreen');
            });
            
            return card;
        },

        renderDetailScreen() {
            if (state.currentAccountIndex < 0 || 
                state.currentAccountIndex >= state.appData.accounts.length) {
                this.showScreen('accountSelectScreen');
                return;
            }

            const account = AccountManager.getCurrentAccount();
            Utils.$('headerTitle').textContent = account.name;

            this.renderChallengeButtons(account);
            this.renderCoinDisplay();
            this.renderHistoryCompact();
        },

        renderChallengeButtons(account) {
            const wrapper = Utils.$('challengeButtonsWrapper');
            const container = Utils.$('challengeButtonsContainer');
            wrapper.innerHTML = '';
            
            if (account.challenges.length === 0) {
                container.style.display = 'none';
                state.currentChallengeIndex = -1;
                return;
            }

            container.style.display = 'flex';

            if (state.currentChallengeIndex < 0 || state.currentChallengeIndex >= account.challenges.length) {
                state.currentChallengeIndex = 0;
            }

            account.challenges.forEach((chal, index) => {
                const btn = document.createElement('button');
                btn.classList.add('challenge-button');
                if (index === state.currentChallengeIndex) {
                    btn.classList.add('active');
                }
                btn.textContent = chal.name;
                btn.addEventListener('click', () => {
                    state.currentChallengeIndex = index;
                    this.renderDetailScreen();
                });
                wrapper.appendChild(btn);
            });

            if (!wrapper.dataset.scrollListenerAdded) {
    wrapper.addEventListener('scroll', () => {
        if (wrapper.scrollLeft > 0) {
            container.classList.add('scrolled');
        } else {
            container.classList.remove('scrolled');
        }
    });
    wrapper.dataset.scrollListenerAdded = 'true';
}
},
        

        renderCoinDisplay() {
            const account = AccountManager.getCurrentAccount();
            const challenge = AccountManager.getCurrentChallenge();
            
            if (state.currentChallengeIndex < 0 || !challenge) {
                this.renderEmptyCoinDisplay();
                return;
            }
            
            this.renderActiveCoinDisplay(challenge, account);
        },

        renderEmptyCoinDisplay() {
            const display = Utils.$('coinsDisplay');
            display.classList.add('empty-state');
            Utils.$('exchangeInput').disabled = true;
            Utils.$('exchangeBtn').disabled = true;
        },

         renderActiveCoinDisplay(challenge, account) {
            const display = Utils.$('coinsDisplay');
            display.classList.remove('empty-state');
            
            Utils.$('currentCoins').classList.remove('disabled');
            Utils.$('removeCoinBtn').disabled = challenge.coins <= 0;
            Utils.$('addCoinBtn').disabled = false;

            Utils.$('currentCoins').textContent = challenge.coins;
            Utils.$('currentValue').textContent = challenge.coins * challenge.value;
            Utils.$('coinValueLabel').innerHTML = 
                `${challenge.name}　1コイン = <strong>${challenge.value}</strong>円`;
            
            const totalCoins = account.challenges.reduce((sum, c) => sum + c.totalCoins, 0);
            Utils.$('totalCoins').textContent = totalCoins;

            // 交換ボタンの状態を更新
            const input = Utils.$('exchangeInput');
            input.disabled = false;
            input.min = 1;
            input.max = challenge.coins;
            
            if (!input.value || parseInt(input.value) < 1) {
                input.value = 1;
            }
            
            this.updateExchangeButton(challenge);
        },

        updateExchangeButton(challenge) {
            const input = Utils.$('exchangeInput');
            const btn = Utils.$('exchangeBtn');
            
            if (challenge.coins === 0) {
                input.value = '';
                input.placeholder = 'コインがありません';
                input.disabled = true;
                btn.disabled = true;
                return;
            }
            
            const amount = parseInt(input.value);

            input.min = 1;
            input.max = challenge.coins;
            input.disabled = false;
            input.placeholder = '';
            
            if (!input.value || isNaN(amount) || amount < 1) {
                input.value = 1;
            }

            btn.disabled = isNaN(amount) || amount < 1 || amount > challenge.coins;
        },

        renderHistoryCompact() {
            const account = AccountManager.getCurrentAccount();
            const totalReward = AccountManager.getTotalReward(account);
            Utils.$('totalReward').textContent = `${totalReward.toLocaleString()}円`;
            
            const list = Utils.$('historyList');
            list.innerHTML = '';

            if (account.history.length === 0) {
                list.innerHTML = '<div class="history-empty">まだ履歴はありません</div>';
                return;
            }

            account.history.slice().reverse().forEach(item => {
                list.appendChild(this.createHistoryItem(item));
            });
        },

        createHistoryItem(item) {
            const div = document.createElement('div');
            div.classList.add('history-item');
            
            const date = Utils.formatDate(item.timestamp);
            let description = '';
            let amountText = '';
            let badge = '';
            
            if (item.type === 'exchange') {
                description = `${item.coins}コインを交換`;
                amountText = `+${item.reward.toLocaleString()}円`;
                const challengeName = item.challengeName || 'チャレンジ';
                badge = `<span class="history-challenge-badge">${challengeName}</span>`;
            } else if (item.type === 'reset') {
                description = `データリセット (${item.coins}コイン, ${item.reward}円をリセット)`;
                amountText = '—';
            }

            div.innerHTML = `
                <div>
                    <div class="history-description">
                        <span>${description}</span>
                        ${badge}
                    </div>
                    <div class="history-date">${date}</div>
                </div>
                <div class="history-reward-amount">${amountText}</div>
            `;
            
            return div;
        }
    };

    const ModalManager = {
        show(modalId) {
            Utils.$(modalId).classList.add('show');
            Utils.$('overlay').classList.add('show');
        },

        hide(modalId) {
            Utils.$(modalId).classList.remove('show');
            Utils.$('overlay').classList.remove('show');
        },

        confirm(title, message, callback, confirmText = 'OK', confirmClass = 'btn-confirm-action') {
            Utils.$('confirmTitle').textContent = title;
            Utils.$('confirmMessage').textContent = message;
            Utils.$('confirmActionBtn').textContent = confirmText;
            Utils.$('confirmActionBtn').className = `btn-confirm ${confirmClass}`;
            state.confirmCallback = callback;
            this.show('confirmModal');
        },

        openGlobalSettings() {
            SettingsManager.renderGlobalSettings();
            this.hide('detailSettingsModal');
            this.show('globalSettingsModal');
        },

        openDetailSettings() {
            SettingsManager.renderDetailSettings();
            this.hide('globalSettingsModal');
            this.show('detailSettingsModal');
        }
    };

    const SettingsManager = {
        renderGlobalSettings() {
            const container = Utils.$('accountSettings');
            container.innerHTML = '';
            
            state.appData.accounts.forEach((account, index) => {
                const item = this.createAccountSettingItem(account, index);
                container.appendChild(item);
            });

            const addBtn = Utils.$('addAccountBtn');
            if (state.appData.accounts.length >= CONFIG.MAX_ACCOUNTS) {
                addBtn.classList.add('hidden');
            } else {
                addBtn.classList.remove('hidden');
            }
        },

        createAccountSettingItem(account, index) {
            const div = document.createElement('div');
            div.classList.add('account-item');
            div.innerHTML = `
                <input type="text" value="${account.name}" 
                       data-index="${index}" class="account-name-input">
                <button class="btn-delete-account" data-index="${index}">
                    <svg viewBox="0 0 24 24">
                        <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" />
                    </svg>
                </button>
            `;
            
            const deleteBtn = div.querySelector('.btn-delete-account');
            deleteBtn.onclick = () => this.handleDeleteAccount(index);
            
            return div;
        },

        handleDeleteAccount(index) {
            const account = state.appData.accounts[index];
            ModalManager.confirm(
                'アカウントの削除',
                `${account.name} を削除してもよろしいですか?`,
                () => {
                    AccountManager.deleteAccount(index);
                    this.renderGlobalSettings();
                    UIManager.showScreen('accountSelectScreen');
                    ModalManager.hide('confirmModal');
                },
                '削除する',
                'btn-confirm-action'
            );
        },

        saveGlobalSettings() {
            this.saveAccountNames();
            DataManager.save();
            ModalManager.hide('globalSettingsModal');
            UIManager.showScreen('accountSelectScreen');
        },

        saveAccountNames() {
            document.querySelectorAll('.account-name-input').forEach(input => {
                const index = parseInt(input.dataset.index);
                const account = state.appData.accounts[index];
                if (account) {
                    account.name = Utils.sanitizeAccountName(
                        input.value,
                        `アカウント ${index + 1}`
                    );
                }
            });
        },

        renderDetailSettings() {
            const account = AccountManager.getCurrentAccount();
            if (!account) return;

            Utils.$('detailModalTitle').textContent = `${account.name} の設定`;
            Utils.$('detailAccountNameInput').value = account.name;

            const container = Utils.$('detailChallengeSettings');
            container.innerHTML = '';

            account.challenges.forEach((challenge, index) => {
                const item = this.createChallengeSettingItem(challenge, index);
                container.appendChild(item);
            });
        },

        createChallengeSettingItem(challenge, index) {
            const div = document.createElement('div');
            div.classList.add('challenge-item');
            div.dataset.index = index;

            div.innerHTML = `
                <div class="challenge-header">
                    <h4>チャレンジ ${index + 1}</h4>
                    <button class="btn-delete-challenge" data-index="${index}">
                        <svg viewBox="0 0 24 24">
                            <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" />
                        </svg>
                    </button>
                </div>
                <div class="challenge-inputs-group">
                    <label for="chal-name-${index}">チャレンジ名</label>
                    <input type="text" id="chal-name-${index}" 
                           value="${challenge.name}" 
                           data-index="${index}" 
                           class="challenge-name-input">
                </div>
                <div class="challenge-inputs-group">
                    <label for="chal-value-${index}">1コインあたりのおこづかい</label>
                    <div class="challenge-value-wrapper">
                        <div class="input-with-suffix">
                            <input type="number" id="chal-value-${index}" 
                                   value="${challenge.value}" 
                                   min="1" 
                                   data-index="${index}" 
                                   class="challenge-value-input">
                            <span class="suffix">円</span>
                        </div>
                    </div>
                </div>
            `;

            const deleteBtn = div.querySelector('.btn-delete-challenge');
            deleteBtn.onclick = () => this.handleDeleteChallenge(index);

            return div;
        },

        handleDeleteChallenge(index) {
            const account = AccountManager.getCurrentAccount();
            const challenge = account.challenges[index];
            
            ModalManager.confirm(
                'チャレンジの削除',
                `チャレンジ「${challenge.name}」を削除してもよろしいですか?`,
                () => {
                    AccountManager.deleteChallenge(account, index);
                    DataManager.save();
                    this.renderDetailSettings();
                    UIManager.renderDetailScreen();
                    ModalManager.hide('confirmModal');
                },
                '削除する',
                'btn-confirm-action'
            );
        },

        saveDetailSettings() {
            const account = AccountManager.getCurrentAccount();
            if (!account) return;

            account.name = Utils.sanitizeAccountName(
                Utils.$('detailAccountNameInput').value,
                account.name
            );

            this.saveChallengeSettings(account);
            DataManager.save();
            ModalManager.hide('detailSettingsModal');
            UIManager.renderDetailScreen();
        },

        saveChallengeSettings(account) {
            document.querySelectorAll('.challenge-item').forEach(item => {
                const index = parseInt(item.dataset.index);
                const challenge = account.challenges[index];
                
                if (challenge) {
                    const nameInput = item.querySelector('.challenge-name-input');
                    const valueInput = item.querySelector('.challenge-value-input');
                    
                    challenge.name = Utils.sanitizeAccountName(
                        nameInput.value,
                        `チャレンジ ${index + 1}`
                    );
                    challenge.value = Utils.validateChallengeValue(
                        parseInt(valueInput.value)
                    );
                }
            });
        },

        saveInputsBeforeAdd() {
            const account = AccountManager.getCurrentAccount();
            if (!account) return;

            const nameInput = Utils.$('detailAccountNameInput');
            if (nameInput && nameInput.value.trim()) {
                account.name = nameInput.value.trim();
            }

            this.saveChallengeSettings(account);
        }
    };

    const CelebrationManager = {
        show(title, text) {
            Utils.$('celebration').querySelector('h2').textContent = title;
            Utils.$('celebrationText').innerHTML = text;
            Utils.$('celebration').classList.add('show');
            Utils.$('overlay').classList.add('show');
            this.createConfetti();

            setTimeout(() => {
                Utils.$('celebration').classList.remove('show');
                Utils.$('overlay').classList.remove('show');
                if (state.currentAccountIndex !== -1) {
                    const account = AccountManager.getCurrentAccount();
                    if (account) {
                        Utils.$('headerTitle').textContent = account.name;
                    }
                }
            }, CONFIG.CELEBRATION_DURATION);
        },

        createConfetti() {
            for (let i = 0; i < CONFIG.CONFETTI_COUNT; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = 
                    CONFIG.CONFETTI_COLORS[Math.floor(Math.random() * CONFIG.CONFETTI_COLORS.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `-20vh`;
                confetti.style.animation = 
                    `confetti-fall 3s ease-out forwards ${Math.random() * 2}s`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }
    };

    const EventHandlers = {
        init() {
            Utils.$('globalSettingsBtn').addEventListener('click', 
                () => ModalManager.openGlobalSettings());
            Utils.$('detailSettingsBtn').addEventListener('click', 
                () => ModalManager.openDetailSettings());
            Utils.$('backBtn').addEventListener('click', 
                () => UIManager.showScreen('accountSelectScreen'));

            Utils.$('closeGlobalSettingsBtn').addEventListener('click', 
                () => ModalManager.hide('globalSettingsModal'));
            Utils.$('saveGlobalSettingsBtn').addEventListener('click', 
                () => SettingsManager.saveGlobalSettings());

            Utils.$('addAccountBtn').addEventListener('click', () => {
                SettingsManager.saveAccountNames();
                if (AccountManager.addAccount()) {
                    SettingsManager.renderGlobalSettings();
                }
            });

            Utils.$('closeDetailSettingsBtn').addEventListener('click', 
                () => ModalManager.hide('detailSettingsModal'));
            Utils.$('addChallengeInDetailModalBtn').addEventListener('click', () => {
                SettingsManager.saveInputsBeforeAdd();
                const account = AccountManager.getCurrentAccount();
                if (account) {
                    AccountManager.addChallenge(account);
                    SettingsManager.renderDetailSettings();
                }
            });
            Utils.$('saveDetailSettingsBtn').addEventListener('click', 
                () => SettingsManager.saveDetailSettings());

            Utils.$('addCoinBtn').addEventListener('click', 
                () => CoinManager.addCoin());
            Utils.$('removeCoinBtn').addEventListener('click', 
                () => CoinManager.removeCoin());

            Utils.$('exchangeInput').addEventListener('input', 
                () => UIManager.renderCoinDisplay());
            Utils.$('exchangeBtn').addEventListener('click', 
                () => this.handleExchange());

            Utils.$('toggleHistoryBtn').addEventListener('click', () => {
                const details = Utils.$('historyDetails');
                const text = Utils.$('historyToggleText');
                const isShowing = details.classList.toggle('show');
                text.textContent = isShowing ? '閉じる' : 'くわしく見る';
            });

            Utils.$('resetAllBtn').addEventListener('click', 
                () => this.handleResetAll());
            Utils.$('resetCurrentBtn').addEventListener('click', 
                () => this.handleResetCurrent());

            Utils.$('cancelBtn').addEventListener('click', 
                () => ModalManager.hide('confirmModal'));
            Utils.$('confirmActionBtn').addEventListener('click', () => {
                if (state.confirmCallback) {
                    state.confirmCallback();
                    state.confirmCallback = null;
                }
            });
        },

        handleExchange() {
            const amount = parseInt(Utils.$('exchangeInput').value);
            const challenge = AccountManager.getCurrentChallenge();
            
            if (challenge && amount > 0 && amount <= challenge.coins) {
                const reward = amount * challenge.value;
                ModalManager.confirm(
                    '交換の確認',
                    `${amount}コインを${reward.toLocaleString()}円のおこづかいと交換しますか?`,
                    () => {
                        CoinManager.exchange(amount);
                        ModalManager.hide('confirmModal');
                        setTimeout(() => {  // 少し待ってからお祝い表示
                            CoinManager.exchange(amount);
                        }, 100);
                    },
                    '交換する',
                    'exchange-confirm'
                );
            } else {
                alert('交換できるコイン数が正しくありません。');
            }
        },

        handleResetAll() {
            ModalManager.confirm(
                '全データリセット',
                '全てのアカウントデータと設定を完全に削除します。よろしいですか?',
                () => {
                    DataManager.reset();
                    state.currentAccountIndex = -1;
                    ModalManager.hide('globalSettingsModal');
                    ModalManager.hide('confirmModal');
                    UIManager.showScreen('accountSelectScreen');
                },
                '全リセット',
                'btn-confirm-action'
            );
        },

        handleResetCurrent() {
            const account = AccountManager.getCurrentAccount();
            if (!account) return;
            
            const totalCoins = AccountManager.getTotalCoins(account);
            const totalReward = AccountManager.getTotalReward(account);

            ModalManager.confirm(
                'アカウントリセット',
                `${account.name}のコイン (${totalCoins}枚) と 履歴 (${totalReward}円分) をリセットします。よろしいですか?`,
                () => {
                    AccountManager.resetAccount(account);
                    ModalManager.hide('detailSettingsModal');
                    ModalManager.hide('confirmModal');
                    UIManager.renderDetailScreen();
                },
                'リセットする',
                'btn-confirm-action'
            );
        }
    };

    function initApp() {
        DataManager.load();
        
        if (state.appData.accounts.length > 0) {
            state.currentAccountIndex = 0;
            state.currentChallengeIndex = 0;
        }
        
        EventHandlers.init();
        UIManager.showScreen('accountSelectScreen');
    }

    document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
