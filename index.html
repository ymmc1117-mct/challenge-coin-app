<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Coin">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-180.png"> 
    <title>Challenge Coin!</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* CSS„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÁúÅÁï• (Â§âÊõ¥„Å™„Åó) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        body {
            font-family: 'M PLUS Rounded 1c', 'Varela Round', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        @media (max-width: 768px) {
            .header { padding: 20px 15px; }
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            color: #ff6098;
            letter-spacing: 1px;
            text-shadow: 2px 2px 8px rgba(255, 96, 152, 0.3);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 28px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 24px; }
        }

        .header-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .header-btn:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-btn svg {
            width: 24px;
            height: 24px;
            fill: rgba(0, 0, 0, 0.4);
        }

        .back-btn { left: 20px; }
        .settings-btn { right: 20px; }

        @media (max-width: 768px) {
            .back-btn { left: 15px; }
            .settings-btn { right: 15px; }
        }

        .challenge-buttons-container {
            padding: 10px 30px;
            background: white;
            display: none; 
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #eee;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .challenge-buttons-container::-webkit-scrollbar {
            display: none;
        }

        .challenge-button {
            background: #fff0f5;
            color: #ff6b9d;
            border: 2px solid #ffc8d9;
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .challenge-button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .challenge-button.active {
            background: #ff6b9d;
            color: white;
            border-color: #ff6b9d;
            box-shadow: 0 4px 8px rgba(255, 107, 157, 0.2);
        }

        .challenge-buttons-wrapper {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            overflow-x: auto;
        }


        .content {
            padding: 30px;
        }

        @media (max-width: 768px) {
            .content { padding: 20px; }
        }

        @media (max-width: 480px) {
            .content { padding: 15px; }
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .account-list {
            display: grid;
            gap: 15px;
        }

        .account-card {
            background: #e0f7fa;
            border-radius: 15px;
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .account-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .account-card h3 {
            font-size: 20px;
            color: #333;
        }

        .coins-info {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .coins-number-list {
            font-size: 28px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .add-account-btn {
            background-color: #e6f7e9;
            border: 2px dashed #81c784;
            border-radius: 15px;
            padding: 18px 25px; 
            cursor: pointer;
            text-align: center;
            font-size: 18px;
            color: #4caf50;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .add-account-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .add-account-btn:disabled {
            background-color: #f7e6e6;
            border: 2px dashed #ccc;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }


        .coins-display {
            background: #e6faff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        @media (max-width: 768px) {
            .coins-display { padding: 20px; }
        }

        .coin-value-label {
            display: block;
            width: fit-content;
            margin: 0 auto 10px;
            font-size: 16px;
            color: #666;
            background: #fff0f5;
            padding: 5px 10px;
            border-radius: 10px;
            border: 1px solid #ffc8d9;
        }

        .coin-value-label strong {
            color: #ff6b9d;
        }

        .coins-label {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }

        .coins-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .coins-number {
            font-size: 72px;
            font-weight: bold;
            color: #ff6b9d;
        }
        
        .coins-number.disabled {
            color: #ccc;
        }

        @media (max-width: 768px) {
            .coins-number { font-size: 60px; }
        }

        @media (max-width: 480px) {
            .coins-number { font-size: 48px; }
        }

        .coin-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .coin-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .coin-btn:disabled {
            background: #eee !important;
            color: #ccc !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        .coin-btn-add {
            background: #a8e6cf;
            color: #333;
        }

        .coin-btn-minus {
            background: #ffb3ba;
            color: #333;
        }

        .coins-value {
            font-size: 24px;
            color: #333;
            font-weight: bold;
            margin-top: 10px;
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        .total-coins {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255, 255, 255, 0.5);
            font-size: 16px;
            color: #555;
        }

        .total-coins-number {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .exchange-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .exchange-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .exchange-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .exchange-input {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .exchange-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            font-family: inherit;
        }
        
        .exchange-input span {
            font-size: 16px;
            color: #555;
        }

        .btn-exchange {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-exchange:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .btn-exchange:disabled {
            background: #eee;
            color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }


        .history-compact {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .history-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .history-total-label {
            font-size: 14px;
            color: #999;
        }

        .history-total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .btn-show-history {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-show-history:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .history-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f8f9fa;
            display: none;
        }

        .history-details.show {
            display: block;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
        }

        .history-description {
            font-weight: bold;
            color: #555;
            margin-bottom: 3px;
        }

        .history-date {
            color: #999;
            font-size: 12px;
        }

        .history-reward-amount {
            color: #ff6b9d;
            font-weight: bold;
        }

        .history-empty {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .setting-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f8f9fa;
        }

        .setting-section:last-child {
            border-bottom: none;
        }

        .setting-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .account-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .account-item input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .btn-delete-account {
            padding: 10px 15px;
            background: #ffebee;
            border: none;
            border-radius: 10px;
            color: #c62828;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-delete-account:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .challenge-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .challenge-header h4 {
            font-size: 16px;
        }

        .challenge-inputs-group {
            margin-bottom: 15px;
        }

        .challenge-inputs-group label {
            display: block;
            font-size: 14px;
            color: #999;
            margin-bottom: 5px;
        }

        .challenge-inputs-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .challenge-value-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-with-suffix {
            flex-grow: 1;
            position: relative;
        }

        .input-with-suffix input {
            width: 100%;
            text-align: right;
            padding-right: 40px;
        }

        .input-with-suffix .suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #666;
            pointer-events: none;
        }


        .btn-delete-challenge {
            padding: 8px 12px;
            background: #ffebee;
            border: none;
            border-radius: 8px;
            color: #c62828;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-delete-challenge:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-add, .btn-add-account-modal { /* .btn-add-account-modal„ÇíËøΩÂä† */
            background-color: #e6f7e9;
            border: 2px dashed #81c784;
            border-radius: 10px;
            color: #4caf50;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            padding: 12px;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center; /* ‰∏≠Â§ÆÊèÉ„Åà„ÇíËøΩÂä† */
        }
        .btn-add:active, .btn-add-account-modal:active { /* .btn-add-account-modal:active„ÇíËøΩÂä† */
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Éú„Çø„É≥„ÅÆÁÑ°ÂäπÂåñ„Çπ„Çø„Ç§„É´ */
        .btn-add-account-modal:disabled {
            background-color: #f7e6e6;
            border: 2px dashed #ccc;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
        }


        .btn-save {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            margin-bottom: 20px;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-save:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .reset-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-reset {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-reset:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-reset-all {
            background: #ffebee;
            color: #c62828;
        }

        .btn-reset-child {
            background: #fff4e6;
            color: #e65100;
        }

        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .confirm-content h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .confirm-content p {
            color: #666;
            margin-bottom: 25px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-confirm {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-confirm:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-cancel {
            background: #e9ecef;
            color: #333;
        }

        .btn-confirm-action {
            background: #e57373;
            color: white;
            border: 1px solid #c62828;
        }
        
        .exchange-confirm {
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            color: #333 !important;
            border: 1px solid #ffc8d9 !important;
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1002;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .celebration.show {
            display: block;
        }

        .celebration h2 {
            font-size: 36px;
            color: #ff6b9d;
            margin-bottom: 20px;
        }
        
        .celebration-amount {
            color: #ff6b9d;
            font-weight: 800;
            font-size: 1.2em;
        }

        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            z-index: 1001;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="header-btn back-btn" id="backBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
                </svg>
            </button>
            <h1 id="headerTitle">Challenge Coin!</h1>
            <button class="header-btn settings-btn" id="globalSettingsBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
            <button class="header-btn settings-btn" id="detailSettingsBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
        </div>

        <div class="challenge-buttons-container" id="challengeButtonsContainer">
            <div class="challenge-buttons-wrapper" id="challengeButtonsWrapper">
            </div>
        </div>
        
        <div class="content">
            <div class="screen active" id="accountSelectScreen">
                <div class="account-list" id="accountList"></div>
            </div>

            <div class="screen" id="accountDetailScreen">
                <div class="coins-display">
                    <div class="coin-value-label" id="coinValueLabel"></div>
                    <div class="coins-label">ÁèæÂú®„ÅÆ„Ç≥„Ç§„É≥</div>
                    <div class="coins-main">
                        <button class="coin-btn coin-btn-minus" id="removeCoinBtn">‚àí</button>
                        <div class="coins-number" id="currentCoins">0</div>
                        <button class="coin-btn coin-btn-add" id="addCoinBtn">+</button>
                    </div>
                    <div class="coins-value">
                        = <span id="currentValue">0</span>ÂÜÜ
                    </div>
                    <div class="total-coins">
                        <span id="totalCoinsLabel">„Åì„Çå„Åæ„Åß„ÅÆ„Ç≥„Ç§„É≥ÂêàË®à</span>: 
                        <span class="total-coins-number" id="totalCoins">0</span>„Ç≥„Ç§„É≥
                    </div>
                </div>

                <div class="exchange-section">
                    <h3>„Ç≥„Ç§„É≥„ÅÆ‰∫§Êèõ</h3>
                    <div class="exchange-input">
                        <input type="number" id="exchangeInput" min="1" value="1">
                        <span>„Ç≥„Ç§„É≥</span>
                    </div>
                    <button class="btn-exchange" id="exchangeBtn">„Åä„Åì„Å•„Åã„ÅÑ„Å®‰∫§Êèõ„Åô„Çã</button>
                </div>

                <div class="history-compact">
                    <div class="history-summary">
                        <div class="history-total">
                            <div class="history-total-label">„Åì„Çå„Åæ„Åß„ÅÆ„Åä„Åì„Å•„Åã„ÅÑÂêàË®à</div>
                            <div class="history-total-amount" id="totalReward">0ÂÜÜ</div>
                        </div>
                        <button class="btn-show-history" id="toggleHistoryBtn">
                            <span id="historyToggleText">„Åè„Çè„Åó„ÅèË¶ã„Çã</span> </button>
                    </div>
                    <div class="history-details" id="historyDetails">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="globalSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÂÖ®‰ΩìË®≠ÂÆö</h2>
                <button class="close-btn" id="closeGlobalSettingsBtn">√ó</button>
            </div>
            <div class="setting-section">
                <h3>„Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜÔºàÊúÄÂ§ß4‰∫∫Ôºâ</h3>
                <div id="accountSettings"></div>
                <button class="btn-add-account-modal" id="addAccountInModalBtn">Ôºã „Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</button>
            </div>
            <div class="setting-section">
                <h3>„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà</h3>
                <div class="reset-buttons">
                    <button class="btn-reset btn-reset-all" id="resetAllBtn">ÂÖ®„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
            <button class="btn-save" id="saveGlobalSettingsBtn">‰øùÂ≠ò</button>
        </div>
    </div>

    <div class="modal" id="detailSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailModalTitle">„Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö</h2>
                <button class="close-btn" id="closeDetailSettingsBtn">√ó</button>
            </div>
            <div class="setting-section">
                <h3>„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç</h3>
                <div class="account-item">
                    <input type="text" id="detailAccountNameInput">
                </div>
            </div>
            <div class="setting-section">
                <h3>„ÉÅ„É£„É¨„É≥„Ç∏ÁÆ°ÁêÜ</h3>
                <div id="detailChallengeSettings"></div>
                <button class="btn-add" id="addChallengeInDetailModalBtn">Ôºã „ÉÅ„É£„É¨„É≥„Ç∏„ÇíËøΩÂä†</button>
            </div>
            <button class="btn-save" id="saveDetailSettingsBtn">‰øùÂ≠ò</button>
            <div class="setting-section">
                <h3>„Éá„Éº„Çø„ÅÆ„É™„Çª„ÉÉ„Éà</h3>
                <div class="reset-buttons">
                    <button class="btn-reset btn-reset-child" id="resetCurrentBtn">„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà</button>
                </div>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 id="confirmTitle">Á¢∫Ë™ç</h3>
            <p id="confirmMessage"></p>
            <div class="confirm-buttons">
                <button class="btn-confirm btn-cancel" id="cancelBtn">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-confirm btn-confirm-action" id="confirmActionBtn">„ÅØ„ÅÑ</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="celebration" id="celebration">
        <h2>„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅüéâ</h2>
        <p id="celebrationText"></p>
    </div>

    <script>
        const MAX_ACCOUNTS = 4;
        const STORAGE_KEY = 'challengeCoinData';
        
        let appData = { 
            accounts: [],
        };
        let currentAccountIndex = -1;
        let currentChallengeIndex = 0;
        let confirmCallback = null;

        const $ = id => document.getElementById(id);

        // „Éá„Éº„Çø‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data && Array.isArray(data.accounts)) {
                        data.accounts.forEach(acc => {
                            if (!acc.challenges) acc.challenges = [];
                            if (!acc.history) acc.history = [];
                            
                            // Êóß„Éá„Éº„Çø„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥Âá¶ÁêÜ
                            if (typeof acc.coins === 'number') {
                                if (acc.challenges.length === 0) {
                                    acc.challenges.push({ name: '„ÅäÊâã‰ºù„ÅÑ', value: 10, coins: 0, totalCoins: 0 });
                                }
                                if (acc.challenges.length > 0) {
                                    // Êó¢Â≠ò„ÅÆcoins„ÇíÊúÄÂàù„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Å´Áµ±Âêà (Á∞°ÊòìÁöÑ„Å™ÁßªË°å)
                                    acc.challenges[0].coins += acc.coins; 
                                    acc.challenges[0].totalCoins += acc.totalCoins || 0;
                                }
                                delete acc.coins;
                                delete acc.totalCoins;
                            }
                        });
                        appData = data;
                    }
                }
                
                // ÂàùÂõûËµ∑ÂãïÊôÇ„ÅÆ„Éá„Éï„Ç©„É´„Éà„Éá„Éº„ÇøË®≠ÂÆö
                if (appData.accounts.length === 0) {
                    appData.accounts.push({ 
                        name: 'Ôºà„Ç¢„Ç´„Ç¶„É≥„Éà1Ôºâ', 
                        challenges: [
                            { name: '„ÅäÊâã‰ºù„ÅÑ', value: 10, coins: 0, totalCoins: 0 },
                            { name: 'Áøí„ÅÑ‰∫ã', value: 50, coins: 0, totalCoins: 0 }
                        ],
                        history: []
                    });
                    appData.accounts.push({ 
                        name: 'Ôºà„Ç¢„Ç´„Ç¶„É≥„Éà2Ôºâ', 
                        challenges: [
                            { name: 'ÂÆøÈ°å', value: 20, coins: 0, totalCoins: 0 }
                        ],
                        history: []
                    });
                    saveData();
                }

                if (currentAccountIndex === -1 && appData.accounts.length > 0) {
                    currentAccountIndex = 0; // Â∏∏„Å´ÊúÄÂàù„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÈÅ∏Êäû
                }
            } catch (e) {
                console.error('Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                // „Ç®„É©„ÉºÊôÇ„ÅØÂàùÊúü„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç
                appData.accounts = [
                    { 
                        name: 'Ôºà„Ç¢„Ç´„Ç¶„É≥„Éà1Ôºâ', 
                        challenges: [
                            { name: '„ÅäÊâã‰ºù„ÅÑ', value: 10, coins: 0, totalCoins: 0 },
                            { name: 'Áøí„ÅÑ‰∫ã', value: 50, coins: 0, totalCoins: 0 }
                        ],
                        history: []
                    }
                ];
                currentAccountIndex = 0;
                saveData();
            }
        }

        // ÁîªÈù¢Âà∂Âæ°
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            $(screenId).classList.add('active');

            // „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°
            if (screenId === 'accountSelectScreen') {
                $('headerTitle').textContent = 'Challenge Coin!';
                $('backBtn').style.display = 'none';
                $('globalSettingsBtn').style.display = 'flex';
                $('detailSettingsBtn').style.display = 'none';
                $('challengeButtonsContainer').style.display = 'none';
            } else if (screenId === 'accountDetailScreen') {
                const currentAccount = appData.accounts[currentAccountIndex];
                $('headerTitle').textContent = currentAccount ? currentAccount.name : '„Ç¢„Ç´„Ç¶„É≥„ÉàË©≥Á¥∞';
                $('backBtn').style.display = 'flex';
                $('globalSettingsBtn').style.display = 'none';
                $('detailSettingsBtn').style.display = 'flex';
                $('challengeButtonsContainer').style.display = 'block';
            }
        }

        // „Ç¢„Ç´„Ç¶„É≥„Éà„Ç´„Éº„Éâ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderAccountCards() {
            const list = $('accountList');
            list.innerHTML = '';
            
            if (appData.accounts.length === 0) {
                list.innerHTML = '<p class="history-empty">„Ç¢„Ç´„Ç¶„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖ®‰ΩìË®≠ÂÆö„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
                return;
            }

            appData.accounts.forEach((account, index) => {
                const totalCoins = account.challenges.reduce((sum, c) => sum + c.coins, 0);
                const card = document.createElement('div');
                card.className = 'account-card';
                card.innerHTML = `
                    <h3>${account.name || 'ÂêçÂâç„Å™„Åó'}</h3>
                    <div class="coins-info">
                        <span class="coins-number-list">${totalCoins}</span>
                        <span>„Ç≥„Ç§„É≥</span>
                    </div>
                `;
                card.onclick = () => selectAccount(index);
                list.appendChild(card);
            });
            
            // „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„Åß„ÅØ„ÄÅ„Ç¢„Ç´„Ç¶„É≥„Éà„É™„Çπ„Éà„ÅÆ‰∏ã„Å´„Éú„Çø„É≥„ÇíËøΩÂä†„Åó„Å™„ÅÑÔºà‰ª£„Çè„Çä„Å´Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ÂÜÖ„Å´ÁßªÂãïÔºâ
        }

        // „Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏Êäû
        function selectAccount(index) {
            if (index < 0 || index >= appData.accounts.length) return;
            currentAccountIndex = index;
            currentChallengeIndex = 0; // „Ç¢„Ç´„Ç¶„É≥„ÉàÂ§âÊõ¥ÊôÇ„Å´ÊúÄÂàù„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Å´„É™„Çª„ÉÉ„Éà
            renderChallengeButtons();
            renderDetailScreen();
            switchScreen('accountDetailScreen');
        }

        // „ÉÅ„É£„É¨„É≥„Ç∏„Éú„Çø„É≥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderChallengeButtons() {
            const wrapper = $('challengeButtonsWrapper');
            wrapper.innerHTML = '';
            
            const currentAccount = appData.accounts[currentAccountIndex];
            if (!currentAccount || currentAccount.challenges.length === 0) {
                 $('challengeButtonsContainer').style.display = 'none';
                return;
            }
            $('challengeButtonsContainer').style.display = 'block';

            currentAccount.challenges.forEach((challenge, index) => {
                const button = document.createElement('button');
                button.className = 'challenge-button' + (index === currentChallengeIndex ? ' active' : '');
                button.textContent = challenge.name;
                button.dataset.index = index;
                button.onclick = () => selectChallenge(index);
                wrapper.appendChild(button);
            });
        }

        // „ÉÅ„É£„É¨„É≥„Ç∏ÈÅ∏Êäû
        function selectChallenge(index) {
            currentChallengeIndex = index;
            renderChallengeButtons();
            renderDetailScreen();
        }

        // Ë©≥Á¥∞ÁîªÈù¢„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderDetailScreen() {
            if (currentAccountIndex === -1) return;
            
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            
            // „Éò„ÉÉ„ÉÄ„Éº„Çø„Ç§„Éà„É´Êõ¥Êñ∞
            $('headerTitle').textContent = account.name || '„Ç¢„Ç´„Ç¶„É≥„ÉàË©≥Á¥∞';

            // „Ç≥„Ç§„É≥Ë°®Á§∫ÈÉ®ÂàÜ
            const totalCoins = account.challenges.reduce((sum, c) => sum + c.coins, 0);
            
            $('currentCoins').textContent = totalCoins.toLocaleString();
            
            let coinValue = 0;
            let coinValueLabelText = '„ÉÅ„É£„É¨„É≥„Ç∏„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
            let totalCoinsLabelText = '„Åì„Çå„Åæ„Åß„ÅÆ„Ç≥„Ç§„É≥ÂêàË®à';
            
            if (challenge) {
                 coinValue = challenge.value;
                 coinValueLabelText = `<strong>${challenge.value}ÂÜÜ/1„Ç≥„Ç§„É≥</strong>`;
                 $('coins-number').classList.remove('disabled');
                 $('addCoinBtn').disabled = false;
                 $('removeCoinBtn').disabled = totalCoins <= 0;
            } else {
                 $('coins-number').classList.add('disabled');
                 $('addCoinBtn').disabled = true;
                 $('removeCoinBtn').disabled = true;
            }

            // ÁèæÂú®„ÅÆ„Ç≥„Ç§„É≥„Å®Á≠â‰æ°‰æ°ÂÄ§„ÅÆË°®Á§∫
            $('coinValueLabel').innerHTML = `1„Ç≥„Ç§„É≥„ÅÇ„Åü„Çä${coinValueLabelText}`;
            $('currentValue').textContent = (totalCoins * coinValue).toLocaleString();
            $('totalCoinsLabel').textContent = totalCoinsLabelText;
            
            // Á∑èÁç≤Âæó„Ç≥„Ç§„É≥Ë°®Á§∫
            const grandTotalCoins = account.challenges.reduce((sum, c) => sum + c.totalCoins, 0);
            $('totalCoins').textContent = grandTotalCoins.toLocaleString();

            // ‰∫§Êèõ„Éú„Çø„É≥„ÅÆÂà∂Âæ°
            $('exchangeInput').max = totalCoins;
            $('exchangeBtn').disabled = totalCoins <= 0;

            // Â±•Ê≠¥Ë°®Á§∫
            renderHistory();
        }
        
        // „Ç≥„Ç§„É≥Êìç‰Ωú
        function addCoin() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            if (!challenge) return; // „ÉÅ„É£„É¨„É≥„Ç∏„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊìç‰Ωú‰∏çÂèØ
            
            challenge.coins++;
            challenge.totalCoins++; // Á∑èÁç≤Âæó„Ç≥„Ç§„É≥„ÇÇÂ¢ó„ÇÑ„Åô
            
            // Â±•Ê≠¥„Å´ËøΩÂä†
            account.history.unshift({
                type: 'gain',
                description: `${challenge.name}ÈÅîÊàê`,
                amount: 1,
                value: challenge.value,
                timestamp: Date.now()
            });

            saveData();
            renderDetailScreen();
            // „Ç§„Éô„É≥„Éà„ÇíË¶ñË¶öÂåñÔºàÁ¥ôÂêπÈõ™„Å™„Å©Ôºâ
        }

        function removeCoin() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            const totalCoins = account.challenges.reduce((sum, c) => sum + c.coins, 0);

            if (totalCoins <= 0 || !challenge) return;
            
            // ÁèæÂú®„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Åã„ÇâÊ∏õ„Çâ„Åô„ÅÆ„ÅåËá™ÁÑ∂„Å†„Åå„ÄÅ‰ªäÂõû„ÅØ„Ç¢„Ç´„Ç¶„É≥„ÉàÂÖ®‰Ωì„ÅÆ„Ç≥„Ç§„É≥Á∑èÊï∞„Åã„ÇâÊ∏õ„Çâ„ÅôÂá¶ÁêÜ„Å´‰øÆÊ≠£
            // „Å©„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Åã„ÇâÊ∏õ„Çâ„Åô„Åã„Å®„ÅÑ„ÅÜ„É≠„Ç∏„ÉÉ„ÇØ„ÅØË§áÈõë„Å´„Å™„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ„ÄåÊúÄÂæå„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Äç„Åã„ÇâÊ∏õ„Çâ„Åô„Å®„ÅÑ„ÅÜÊö´ÂÆöÁöÑ„Å™„É´„Éº„É´„ÇíÈÅ©Áî®
            // „Çà„ÇäÊ≠£Á¢∫„Å´„ÅØ„ÄÅ„Å©„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„ÅßÁç≤Âæó„Åó„Åü„Ç≥„Ç§„É≥„ÇíÊ∏õ„Çâ„Åô„Åã„ÇíÈÅ∏Êäû„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
            
            // Á∞°ÊòìÁöÑ„Å´„ÄÅÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÉÅ„É£„É¨„É≥„Ç∏„Åã„ÇâÊ∏õ„Çâ„Åô
            if (challenge.coins > 0) {
                 challenge.coins--;
                 
                 account.history.unshift({
                    type: 'spend',
                    description: `„Ç≥„Ç§„É≥Âà©Áî®Ôºà${challenge.name}ÂàÜÔºâ`,
                    amount: -1,
                    value: 0, // Âà©Áî®ÊôÇ„ÅØ‰æ°ÂÄ§„Çí0„Å®„Åó„Å¶„Åä„Åè
                    timestamp: Date.now()
                });
            } else {
                // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„ÉÅ„É£„É¨„É≥„Ç∏„Å´„Ç≥„Ç§„É≥„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ‰ªñ„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Åã„ÇâÊé¢„Åó„Å¶Ê∏õ„Çâ„ÅôÔºà„Åì„Åì„Åß„ÅØÁúÅÁï•Ôºâ
                // ÁèæÂú®„ÅØ„Éú„Çø„É≥Âà∂Âæ°„ÅßÈò≤„Åê
            }

            saveData();
            renderDetailScreen();
        }

        // ‰∫§ÊèõÂá¶ÁêÜ
        function handleExchange() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            const exchangeInput = $('exchangeInput');
            const exchangeAmount = parseInt(exchangeInput.value, 10);
            const totalCoins = account.challenges.reduce((sum, c) => sum + c.coins, 0);
            const currentCoinValue = account.challenges.length > 0 ? account.challenges[currentChallengeIndex].value : 0;
            
            if (isNaN(exchangeAmount) || exchangeAmount <= 0 || exchangeAmount > totalCoins) {
                alert(`ÁÑ°Âäπ„Å™‰∫§Êèõ„Ç≥„Ç§„É≥Êï∞„Åß„Åô„ÄÇ1„Äú${totalCoins}„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                return;
            }

            const reward = exchangeAmount * currentCoinValue;
            
            // Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫
            showConfirm(
                '„Ç≥„Ç§„É≥„ÅÆ‰∫§Êèõ',
                `${exchangeAmount}„Ç≥„Ç§„É≥„Çí${reward.toLocaleString()}ÂÜÜ„ÅÆ„Åä„Åì„Å•„Åã„ÅÑ„Å´‰∫§Êèõ„Åó„Åæ„Åô„ÅãÔºü`,
                '‰∫§Êèõ„Åô„Çã',
                'exchange-confirm',
                () => {
                    // ‰∫§Êèõ„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË°å
                    let remaining = exchangeAmount;
                    
                    // „Ç≥„Ç§„É≥„ÇíÊ∏õ„Çâ„ÅôÔºà„Å©„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„Åã„ÇâÊ∏õ„Çâ„Åô„Åã„ÅØ„ÄÅÂè§„ÅÑ„ÇÇ„ÅÆ„Åã„Çâ„Å™„Å©Âé≥ÂØÜ„Å™„É´„Éº„É´„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ„Åì„Åì„Åß„ÅØÂçòÁ¥î„Å´„ÉÅ„É£„É¨„É≥„Ç∏IDÈ†Ü„Å´Ê∏õ„Çâ„ÅôÔºâ
                    for (const challenge of account.challenges) {
                        const amountToTake = Math.min(remaining, challenge.coins);
                        challenge.coins -= amountToTake;
                        remaining -= amountToTake;
                        if (remaining === 0) break;
                    }

                    // Â±•Ê≠¥„Å´‰∫§ÊèõË®òÈå≤„ÇíËøΩÂä†
                    account.history.unshift({
                        type: 'exchange',
                        description: '„Åä„Åì„Å•„Åã„ÅÑ‰∫§Êèõ',
                        amount: -exchangeAmount,
                        value: reward,
                        timestamp: Date.now()
                    });

                    saveData();
                    renderDetailScreen();
                    showCelebration(reward.toLocaleString()); // „ÅäÁ•ù„ÅÑË°®Á§∫
                }
            );
        }

        // Â±•Ê≠¥Ë°®Á§∫„ÅÆÂàá„ÇäÊõø„Åà
        function toggleHistoryDetails() {
            const historyDetails = $('historyDetails');
            const toggleText = $('historyToggleText');
            if (historyDetails.classList.contains('show')) {
                historyDetails.classList.remove('show');
                toggleText.textContent = '„Åè„Çè„Åó„ÅèË¶ã„Çã';
            } else {
                historyDetails.classList.add('show');
                toggleText.textContent = 'Èñâ„Åò„Çã';
            }
        }

        // Â±•Ê≠¥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderHistory() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            const list = $('historyList');
            list.innerHTML = '';
            
            let totalReward = 0;

            if (account.history.length === 0) {
                list.innerHTML = '<div class="history-empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';
            } else {
                account.history.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'history-item';
                    
                    const date = new Date(item.timestamp);
                    const dateStr = `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    let amountStr = '';
                    let amountClass = '';
                    let rewardDisplay = '';
                    
                    if (item.type === 'gain') {
                        amountStr = `+${item.amount}„Ç≥„Ç§„É≥`;
                        amountClass = 'history-gain-amount';
                        rewardDisplay = `(${item.value}ÂÜÜ)`;
                    } else if (item.type === 'exchange') {
                        amountStr = `${item.amount}„Ç≥„Ç§„É≥`;
                        amountClass = 'history-exchange-amount';
                        rewardDisplay = `<span class="history-reward-amount">‚Üí ${item.value.toLocaleString()}ÂÜÜ</span>`;
                        totalReward += item.value;
                    } else if (item.type === 'spend') {
                        amountStr = `${item.amount}„Ç≥„Ç§„É≥`;
                        amountClass = 'history-spend-amount';
                        rewardDisplay = '';
                    }

                    itemDiv.innerHTML = `
                        <div>
                            <div class="history-description">${item.description}</div>
                            <div class="history-date">${dateStr}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="${amountClass}">${amountStr}</div>
                            ${rewardDisplay}
                        </div>
                    `;
                    list.appendChild(itemDiv);
                });
            }
            
            $('totalReward').textContent = totalReward.toLocaleString() + 'ÂÜÜ';
        }

        // „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderGlobalSettingsModal() {
            const accountSettings = $('accountSettings');
            accountSettings.innerHTML = '';

            appData.accounts.forEach((account, index) => {
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <input type="text" value="${account.name}" data-index="${index}" class="account-name-input">
                    <button class="btn-delete-account" data-index="${index}">ÂâäÈô§</button>
                `;
                accountSettings.appendChild(item);
            });
            
            // „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà„Çã
            const addBtn = $('addAccountInModalBtn');
            if (appData.accounts.length >= MAX_ACCOUNTS) {
                addBtn.disabled = true;
                addBtn.textContent = `„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†ÔºàÊúÄÂ§ß${MAX_ACCOUNTS}‰∫∫Ôºâ`;
            } else {
                addBtn.disabled = false;
                addBtn.textContent = 'Ôºã „Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†';
            }

            // ‰øùÂ≠òÂá¶ÁêÜ„ÅÆ„Åü„ÇÅ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçË®≠ÂÆö (Êó¢Â≠ò„ÅÆinput„Å´ÂØæ„Åô„Çã„ÇÇ„ÅÆ)
            document.querySelectorAll('.account-name-input').forEach(input => {
                input.onchange = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    appData.accounts[index].name = e.target.value;
                };
            });

            // ÂâäÈô§„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçË®≠ÂÆö
            document.querySelectorAll('.btn-delete-account').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    deleteAccount(index);
                };
            });
            
            showModal('globalSettingsModal');
        }
        
        // „Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§
        function deleteAccount(index) {
            showConfirm(
                '„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§',
                `Êú¨ÂΩì„Å´„Äå${appData.accounts[index].name}„Äç„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Éá„Éº„Çø„ÅØÂÆåÂÖ®„Å´Ê∂àÂéª„Åï„Çå„Åæ„ÅôÔºâ`,
                'ÂâäÈô§„Åô„Çã',
                'btn-confirm-action',
                () => {
                    appData.accounts.splice(index, 1);
                    if (currentAccountIndex === index) {
                        currentAccountIndex = -1; // ÂâäÈô§„Åó„Åü„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÈÅ∏Êäû‰∏≠„Å†„Å£„ÅüÂ†¥Âêà
                    } else if (currentAccountIndex > index) {
                        currentAccountIndex--; // „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË™øÊï¥
                    }
                    saveData();
                    renderAccountSettings(); // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„É™„Çπ„Éà„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                    renderAccountCards(); // „É°„Ç§„É≥ÁîªÈù¢„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                    if (appData.accounts.length === 0) {
                         closeModal('globalSettingsModal');
                         switchScreen('accountSelectScreen');
                    } else if (currentAccountIndex === -1) {
                         currentAccountIndex = 0;
                         selectAccount(0);
                    }
                }
            );
        }
        
        // „É¢„Éº„ÉÄ„É´ÂÜÖ„Åß„Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Éú„Çø„É≥„ÇíÊäº„Åó„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ (Êñ∞Ë¶èËøΩÂä†)
        function addAccountInModal() {
             if (appData.accounts.length >= MAX_ACCOUNTS) return;
             
             const newAccount = {
                name: `Ôºà„Ç¢„Ç´„Ç¶„É≥„Éà${appData.accounts.length + 1}Ôºâ`,
                challenges: [
                    { name: '„ÅäÊâã‰ºù„ÅÑ', value: 10, coins: 0, totalCoins: 0 } // „Éá„Éï„Ç©„É´„Éà„ÉÅ„É£„É¨„É≥„Ç∏
                ],
                history: []
             };
             appData.accounts.push(newAccount);
             saveData();
             renderAccountSettings(); // „É¢„Éº„ÉÄ„É´„ÇíÊõ¥Êñ∞
             renderAccountCards(); // „É°„Ç§„É≥ÁîªÈù¢„ÇíÊõ¥Êñ∞
        }
        
        // „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞Ôºà„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂåñ„ÇíÂê´„ÇÄÔºâ
        function renderAccountSettings() {
             const accountSettings = $('accountSettings');
             accountSettings.innerHTML = '';

             appData.accounts.forEach((account, index) => {
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <input type="text" value="${account.name}" data-index="${index}" class="account-name-input">
                    <button class="btn-delete-account" data-index="${index}">ÂâäÈô§</button>
                `;
                accountSettings.appendChild(item);
             });
            
             // „Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà„Çã
             const addBtn = $('addAccountInModalBtn');
             if (appData.accounts.length >= MAX_ACCOUNTS) {
                 addBtn.disabled = true;
                 addBtn.textContent = `„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†ÔºàÊúÄÂ§ß${MAX_ACCOUNTS}‰∫∫Ôºâ`;
             } else {
                 addBtn.disabled = false;
                 addBtn.textContent = 'Ôºã „Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†';
             }

             // ‰øùÂ≠òÂá¶ÁêÜ„ÅÆ„Åü„ÇÅ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçË®≠ÂÆö (Êó¢Â≠ò„ÅÆinput„Å´ÂØæ„Åô„Çã„ÇÇ„ÅÆ)
             document.querySelectorAll('.account-name-input').forEach(input => {
                 input.onchange = (e) => {
                     const index = parseInt(e.target.dataset.index, 10);
                     appData.accounts[index].name = e.target.value;
                 };
             });

             // ÂâäÈô§„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂÜçË®≠ÂÆö
             document.querySelectorAll('.btn-delete-account').forEach(button => {
                 button.onclick = (e) => {
                     const index = parseInt(e.target.dataset.index, 10);
                     deleteAccount(index);
                 };
             });
        }


        // Ë©≥Á¥∞Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderDetailSettingsModal() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            
            $('detailModalTitle').textContent = `„Äå${account.name}„Äç„ÅÆË®≠ÂÆö`;
            $('detailAccountNameInput').value = account.name;
            
            const challengeSettings = $('detailChallengeSettings');
            challengeSettings.innerHTML = '';
            
            account.challenges.forEach((challenge, index) => {
                const item = document.createElement('div');
                item.className = 'challenge-item';
                item.innerHTML = `
                    <div class="challenge-header">
                        <h4>„ÉÅ„É£„É¨„É≥„Ç∏ ${index + 1}</h4>
                        <button class="btn-delete-challenge" data-index="${index}">ÂâäÈô§</button>
                    </div>
                    <div class="challenge-inputs-group">
                        <label>„ÉÅ„É£„É¨„É≥„Ç∏Âêç</label>
                        <input type="text" value="${challenge.name}" data-index="${index}" data-field="name" class="challenge-input-field">
                    </div>
                    <div class="challenge-inputs-group">
                        <label>Â†±ÈÖ¨ (1„Ç≥„Ç§„É≥„ÅÇ„Åü„Çä)</label>
                        <div class="challenge-value-wrapper">
                            <div class="input-with-suffix">
                                <input type="number" min="1" value="${challenge.value}" data-index="${index}" data-field="value" class="challenge-input-field">
                                <span class="suffix">ÂÜÜ</span>
                            </div>
                        </div>
                    </div>
                `;
                challengeSettings.appendChild(item);
            });
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÂÜçË®≠ÂÆö
            document.querySelectorAll('.challenge-input-field').forEach(input => {
                input.onchange = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    const field = e.target.dataset.field;
                    let value = e.target.value;
                    
                    if (field === 'value') {
                        value = parseInt(value, 10);
                        if (isNaN(value) || value < 1) {
                            alert('Â†±ÈÖ¨„ÅØ1ÂÜÜ‰ª•‰∏ä„ÅÆÊï¥Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            e.target.value = account.challenges[index].value; // ÂÖÉ„Å´Êàª„Åô
                            return;
                        }
                    }

                    account.challenges[index][field] = value;
                };
            });
            
            document.querySelectorAll('.btn-delete-challenge').forEach(button => {
                button.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    deleteChallenge(index);
                };
            });
            
            showModal('detailSettingsModal');
        }

        // „ÉÅ„É£„É¨„É≥„Ç∏ÂâäÈô§
        function deleteChallenge(index) {
             const account = appData.accounts[currentAccountIndex];
             showConfirm(
                '„ÉÅ„É£„É¨„É≥„Ç∏ÂâäÈô§',
                `Êú¨ÂΩì„Å´„Äå${account.challenges[index].name}„Äç„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„ÅßÁç≤Âæó„Åó„Åü„Ç≥„Ç§„É≥„ÅØ„Åù„ÅÆ„Åæ„ÅæÊÆã„Çä„Åæ„ÅôÔºâ`,
                'ÂâäÈô§„Åô„Çã',
                'btn-confirm-action',
                () => {
                    account.challenges.splice(index, 1);
                    saveData();
                    
                    // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„ÉÅ„É£„É¨„É≥„Ç∏„ÇíË™øÊï¥
                    if (currentChallengeIndex === index) {
                         currentChallengeIndex = 0;
                    } else if (currentChallengeIndex > index) {
                         currentChallengeIndex--;
                    }
                    
                    renderDetailSettingsModal(); // „É¢„Éº„ÉÄ„É´„ÇíÊõ¥Êñ∞
                    renderChallengeButtons(); // „É°„Ç§„É≥ÁîªÈù¢„ÅÆ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
                }
             );
        }

        // „ÉÅ„É£„É¨„É≥„Ç∏ËøΩÂä†
        function addChallenge() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            
            account.challenges.push({
                name: `Êñ∞„Åó„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏${account.challenges.length + 1}`,
                value: 10,
                coins: 0,
                totalCoins: 0
            });
            saveData();
            renderDetailSettingsModal();
        }
        
        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(modalId) {
            $('overlay').classList.add('show');
            $(modalId).classList.add('show');
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeModal(modalId) {
            $(modalId).classList.remove('show');
            $('overlay').classList.remove('show');
            // ÂøÖË¶Å„Å´Âøú„Åò„Å¶„É°„Ç§„É≥ÁîªÈù¢„ÇíÂÜç„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            if (modalId === 'globalSettingsModal' || modalId === 'detailSettingsModal') {
                renderDetailScreen();
                renderAccountCards();
                renderChallengeButtons();
            }
        }
        
        // Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showConfirm(title, message, actionText, actionClass, callback) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = message;
            $('confirmActionBtn').textContent = actionText;
            $('confirmActionBtn').className = `btn-confirm ${actionClass}`;
            confirmCallback = callback;
            showModal('confirmModal');
        }
        
        // Á¢∫Ë™ç„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
        function executeConfirmAction() {
            closeModal('confirmModal');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        }
        
        // Á¥ôÂêπÈõ™„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function createConfetti() {
            const colors = ['#ff6b9d', '#a8e6cf', '#dae7f8', '#ffb3ba'];
            const numConfetti = 50;
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = Math.random() * -20 + 'vh';
                confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                document.body.appendChild(confetti);
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }
        
        // „ÅäÁ•ù„ÅÑË°®Á§∫
        function showCelebration(rewardAmount) {
             $('celebrationText').innerHTML = `${rewardAmount}ÂÜÜ„ÅÆ„Åä„Åì„Å•„Åã„ÅÑ„Å®‰∫§Êèõ„Åó„Åæ„Åó„ÅüÔºÅ`;
             $('celebration').classList.add('show');
             $('overlay').classList.add('show');
             createConfetti();
             
             // 3ÁßíÂæå„Å´Èñâ„Åò„Çã
             setTimeout(() => {
                 $('celebration').classList.remove('show');
                 $('overlay').classList.remove('show');
             }, 3000);
        }
        
        // ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà
        function resetAllData() {
            showConfirm(
                'ÂÖ®„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà',
                '„Ç¢„Éó„É™„ÅÆ**ÂÖ®„Å¶**„ÅÆ„Éá„Éº„ÇøÔºà„Ç¢„Ç´„Ç¶„É≥„Éà„ÄÅ„Ç≥„Ç§„É≥„ÄÅÂ±•Ê≠¥„Å™„Å©Ôºâ„ÇíÊú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ',
                'ÂÖ®„É™„Çª„ÉÉ„Éà',
                'btn-confirm-action',
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    appData.accounts = [];
                    currentAccountIndex = -1;
                    loadData(); // ÂàùÊúü„Éá„Éº„Çø„ÅßÂÜç„É≠„Éº„Éâ
                    closeModal('globalSettingsModal');
                    switchScreen('accountSelectScreen');
                }
            );
        }

        // ÁèæÂú®„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
        function resetCurrentAccount() {
             if (currentAccountIndex === -1) return;
             const account = appData.accounts[currentAccountIndex];
             showConfirm(
                '„Ç¢„Ç´„Ç¶„É≥„Éà„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà',
                `Êú¨ÂΩì„Å´„Äå${account.name}„Äç„ÅÆ„Ç≥„Ç§„É≥„Å®Â±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºüÔºàË®≠ÂÆö„Åó„Åü„ÉÅ„É£„É¨„É≥„Ç∏„ÅØÊÆã„Çä„Åæ„ÅôÔºâ`,
                '„É™„Çª„ÉÉ„Éà',
                'btn-confirm-action',
                () => {
                    account.history = [];
                    account.challenges.forEach(c => {
                         c.coins = 0;
                         c.totalCoins = 0;
                    });
                    saveData();
                    closeModal('detailSettingsModal');
                    renderDetailScreen();
                    renderAccountCards(); // „É°„Ç§„É≥ÁîªÈù¢„ÅÆ„Ç≥„Ç§„É≥Êï∞„ÇíÊõ¥Êñ∞
                }
             );
        }


        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function attachEventListeners() {
            // „É°„Ç§„É≥ÁîªÈù¢
            $('addCoinBtn').onclick = addCoin;
            $('removeCoinBtn').onclick = removeCoin;
            $('exchangeBtn').onclick = handleExchange;
            $('toggleHistoryBtn').onclick = toggleHistoryDetails;
            
            // „Éò„ÉÉ„ÉÄ„Éº„Éú„Çø„É≥
            $('globalSettingsBtn').onclick = renderGlobalSettingsModal;
            $('detailSettingsBtn').onclick = renderDetailSettingsModal;
            $('backBtn').onclick = () => {
                switchScreen('accountSelectScreen');
                renderAccountCards();
            };
            
            // „Ç∞„É≠„Éº„Éê„É´Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
            $('closeGlobalSettingsBtn').onclick = () => closeModal('globalSettingsModal');
            $('saveGlobalSettingsBtn').onclick = () => closeModal('globalSettingsModal');
            $('resetAllBtn').onclick = resetAllData;
            // üåü ËøΩÂä†„Åó„Åü„Ç¢„Ç´„Ç¶„É≥„ÉàËøΩÂä†„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº üåü
            $('addAccountInModalBtn').onclick = addAccountInModal; 
            
            // Ë©≥Á¥∞Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
            $('closeDetailSettingsBtn').onclick = () => closeModal('detailSettingsModal');
            $('saveDetailSettingsBtn').onclick = () => {
                // „Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÊâãÂãï„ÅßÊõ¥Êñ∞„Åó„Å¶‰øùÂ≠ò
                if (currentAccountIndex !== -1) {
                    appData.accounts[currentAccountIndex].name = $('detailAccountNameInput').value;
                }
                saveData();
                closeModal('detailSettingsModal');
                renderDetailScreen(); // „Éò„ÉÉ„ÉÄ„Éº„Çø„Ç§„Éà„É´Êõ¥Êñ∞„ÅÆ„Åü„ÇÅ
            };
            $('addChallengeInDetailModalBtn').onclick = addChallenge;
            $('resetCurrentBtn').onclick = resetCurrentAccount;
            
            // Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´
            $('cancelBtn').onclick = () => closeModal('confirmModal');
            $('confirmActionBtn').onclick = executeConfirmAction;
            
            // „Ç™„Éº„Éê„Éº„É¨„Ç§
            $('overlay').onclick = (e) => {
                 // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„ÅÆ„Åå„Ç™„Éº„Éê„Éº„É¨„Ç§Ëá™‰Ωì„Åß„ÄÅ„Åã„Å§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈñâ„Åò„Çã
                 if (e.target.id === 'overlay' && !$('confirmModal').classList.contains('show')) {
                     closeModal('globalSettingsModal');
                     closeModal('detailSettingsModal');
                     $('celebration').classList.remove('show');
                     $('overlay').classList.remove('show');
                 }
            };
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            attachEventListeners();
            renderAccountCards();
            if (currentAccountIndex !== -1) {
                 // ÂàùÂõû„ÅØ„Ç¢„Ç´„Ç¶„É≥„ÉàÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫„Åó„ÄÅ„Éú„Çø„É≥„ÅßË©≥Á¥∞„Å´ÂÖ•„Çã
                 switchScreen('accountSelectScreen');
                 // „ÇÇ„Åó„Ç¢„Ç´„Ç¶„É≥„Éà„Åå1„Å§„Åó„Åã„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅËá™Âãï„ÅßË©≥Á¥∞ÁîªÈù¢„Å´ÈÅ∑Áßª„Åó„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅ„Åì„Åì„Åß„ÅØÈÅ∏ÊäûÁîªÈù¢„Å´Áïô„ÇÅ„Çã
            } else {
                 switchScreen('accountSelectScreen');
            }
        });
    </script>
</body>
</html>
