<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="apple-mobile-web-app-title" content="Coin">

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" href="icon-180.png"> 
    
    <title>Challenge Coin!</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        body {
            font-family: 'M PLUS Rounded 1c', 'Varela Round', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh; /* フルスクリーン時の高さを確保 */
            padding: 20px;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        @media (max-width: 768px) {
            .header { padding: 20px 15px; }
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            color: #ff6098;
            letter-spacing: 1px;
            text-shadow: 2px 2px 8px rgba(255, 96, 152, 0.3);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 28px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 24px; }
        }

        .header-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .header-btn:active {
            transform: translateY(-50%) scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-btn svg {
            width: 24px;
            height: 24px;
            fill: rgba(0, 0, 0, 0.4);
        }

        .back-btn { left: 20px; }
        .settings-btn { right: 20px; }

        @media (max-width: 768px) {
            .back-btn { left: 15px; }
            .settings-btn { right: 15px; }
        }

        .challenge-buttons-container {
            padding: 10px 30px;
            background: white;
            display: none; 
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid #eee;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .challenge-buttons-container::-webkit-scrollbar {
            display: none;
        }

        .challenge-button {
            background: #fff0f5;
            color: #ff6b9d;
            border: 2px solid #ffc8d9;
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .challenge-button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .challenge-button.active {
            background: #ff6b9d;
            color: white;
            border-color: #ff6b9d;
            box-shadow: 0 4px 8px rgba(255, 107, 157, 0.2);
        }

        /* チャレンジ切り替えエリアのスタイル調整 */
        .challenge-buttons-wrapper {
            display: flex;
            gap: 10px;
            flex-grow: 1;
            overflow-x: auto;
        }


        .content {
            padding: 30px;
        }

        @media (max-width: 768px) {
            .content { padding: 20px; }
        }

        @media (max-width: 480px) {
            .content { padding: 15px; }
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .account-list {
            display: grid;
            gap: 15px;
            margin-bottom: 20px; /* 新しいボタンのためのスペース */
        }

        .account-card {
            background: #e0f7fa;
            border-radius: 15px;
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .account-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .account-card h3 {
            font-size: 20px;
            color: #333;
        }

        .coins-info {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .coins-number-list {
            font-size: 28px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .add-account-btn {
            background-color: #e6f7e9;
            border: 2px dashed #81c784;
            border-radius: 15px;
            padding: 18px 25px; 
            cursor: pointer;
            text-align: center;
            font-size: 18px;
            color: #4caf50;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .add-account-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .coins-display {
            background: #e6faff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        @media (max-width: 768px) {
            .coins-display { padding: 20px; }
        }

        .coin-value-label {
            display: block;
            width: fit-content;
            margin: 0 auto 10px;
            font-size: 16px;
            color: #666;
            background: #fff0f5;
            padding: 5px 10px;
            border-radius: 10px;
            border: 1px solid #ffc8d9;
        }

        .coin-value-label strong {
            color: #ff6b9d;
        }

        .coins-label {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }

        .coins-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .coins-number {
            font-size: 72px;
            font-weight: bold;
            color: #ff6b9d;
        }
        
        .coins-number.disabled {
            color: #ccc;
        }

        @media (max-width: 768px) {
            .coins-number { font-size: 60px; }
        }

        @media (max-width: 480px) {
            .coins-number { font-size: 48px; }
        }

        .coin-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .coin-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .coin-btn:disabled {
            background: #eee !important;
            color: #ccc !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        .coin-btn-add {
            background: #a8e6cf;
            color: #333;
        }

        .coin-btn-minus {
            background: #ffb3ba;
            color: #333;
        }

        .coins-value {
            font-size: 24px;
            color: #333;
            font-weight: bold;
            margin-top: 10px;
            display: flex; 
            justify-content: center;
            align-items: center;
        }

        .total-coins {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255, 255, 255, 0.5);
            font-size: 16px;
            color: #555;
        }

        .total-coins-number {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .exchange-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .exchange-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .exchange-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .exchange-input {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .exchange-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            font-family: inherit;
        }
        
        .exchange-input span {
            font-size: 16px;
            color: #555;
        }

        .btn-exchange {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-exchange:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        .btn-exchange:disabled {
            background: #eee;
            color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }


        .history-compact {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .history-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .history-total-label {
            font-size: 14px;
            color: #999;
        }

        .history-total-amount {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
        }

        .btn-show-history {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-show-history:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .history-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f8f9fa;
            display: none;
        }

        .history-details.show {
            display: block;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
        }

        .history-description {
            font-weight: bold;
            color: #555;
            margin-bottom: 3px;
        }

        .history-date {
            color: #999;
            font-size: 12px;
        }

        .history-reward-amount {
            color: #ff6b9d;
            font-weight: bold;
        }

        .history-empty {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .setting-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f8f9fa;
        }

        .setting-section:last-child {
            border-bottom: none;
        }

        .setting-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .account-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .account-item input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .btn-delete-account {
            padding: 10px 15px;
            background: #ffebee;
            border: none;
            border-radius: 10px;
            color: #c62828;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-delete-account:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .challenge-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .challenge-header h4 {
            font-size: 16px;
        }

        .challenge-inputs-group {
            margin-bottom: 15px;
        }

        .challenge-inputs-group label {
            display: block;
            font-size: 14px;
            color: #999;
            margin-bottom: 5px;
        }

        .challenge-inputs-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        .challenge-value-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-with-suffix {
            flex-grow: 1;
            position: relative;
        }

        .input-with-suffix input {
            width: 100%;
            text-align: right;
            padding-right: 40px;
        }

        .input-with-suffix .suffix {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #666;
            pointer-events: none;
        }


        .btn-delete-challenge {
            padding: 8px 12px;
            background: #ffebee;
            border: none;
            border-radius: 8px;
            color: #c62828;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-delete-challenge:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-add {
            background-color: #e6f7e9;
            border: 2px dashed #81c784;
            border-radius: 10px;
            color: #4caf50;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            padding: 12px;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-add:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            margin-bottom: 20px;
            font-family: inherit;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-save:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .reset-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-reset {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-reset:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-reset-all {
            background: #ffebee;
            color: #c62828;
        }

        .btn-reset-child {
            background: #fff4e6;
            color: #e65100;
        }

        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .confirm-content h3 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .confirm-content p {
            color: #666;
            margin-bottom: 25px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-confirm {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-confirm:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-cancel {
            background: #e9ecef;
            color: #333;
        }

        .btn-confirm-action {
            background: #e57373;
            color: white;
            border: 1px solid #c62828;
        }
        
        .exchange-confirm {
            background: linear-gradient(135deg, #dae7f8 0%, #fde5f0 100%);
            color: #333 !important;
            border: 1px solid #ffc8d9 !important;
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            z-index: 1002;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .celebration.show {
            display: block;
        }

        .celebration h2 {
            font-size: 36px;
            color: #ff6b9d;
            margin-bottom: 20px;
        }
        
        .celebration-amount {
            color: #ff6b9d;
            font-weight: 800;
            font-size: 1.2em;
        }

        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            z-index: 1001;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="header-btn back-btn" id="backBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
                </svg>
            </button>
            <h1 id="headerTitle">Challenge Coin!</h1>
            <button class="header-btn settings-btn" id="globalSettingsBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
            <button class="header-btn settings-btn" id="detailSettingsBtn" style="display: none;">
                <svg viewBox="0 0 24 24">
                    <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
                </svg>
            </button>
        </div>

        <div class="challenge-buttons-container" id="challengeButtonsContainer">
            <div class="challenge-buttons-wrapper" id="challengeButtonsWrapper">
            </div>
        </div>
        
        <div class="content">
            <div class="screen active" id="accountSelectScreen">
                <div class="account-list" id="accountList"></div>
                                <button class="add-account-btn" id="addAccountBtnSelect">＋ アカウントを追加</button>
            </div>

            <div class="screen" id="accountDetailScreen">
                <div class="coins-display">
                    <div class="coin-value-label" id="coinValueLabel"></div>
                    <div class="coins-label">現在のコイン</div>
                    <div class="coins-main">
                        <button class="coin-btn coin-btn-minus" id="removeCoinBtn">−</button>
                        <div class="coins-number" id="currentCoins">0</div>
                        <button class="coin-btn coin-btn-add" id="addCoinBtn">+</button>
                    </div>
                    <div class="coins-value">
                        = <span id="currentValue">0</span>円
                    </div>
                    <div class="total-coins">
                        <span id="totalCoinsLabel">これまでのコイン合計</span>: 
                        <span class="total-coins-number" id="totalCoins">0</span>コイン
                    </div>
                </div>

                <div class="exchange-section">
                    <h3>コインの交換</h3>
                    <div class="exchange-input">
                        <input type="number" id="exchangeInput" min="1" value="1">
                        <span>コイン</span>
                    </div>
                    <button class="btn-exchange" id="exchangeBtn">おこづかいと交換する</button>
                </div>

                <div class="history-compact">
                    <div class="history-summary">
                        <div class="history-total">
                            <div class="history-total-label">これまでのおこづかい合計</div>
                            <div class="history-total-amount" id="totalReward">0円</div>
                        </div>
                        <button class="btn-show-history" id="toggleHistoryBtn">
                            <span id="historyToggleText">くわしく見る</span> </button>
                    </div>
                    <div class="history-details" id="historyDetails">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="globalSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>全体設定</h2>
                <button class="close-btn" id="closeGlobalSettingsBtn">×</button>
            </div>
            <div class="setting-section">
                <h3>アカウント管理（最大4人）</h3>
                <div id="accountSettings"></div>
                                <button class="btn-add" id="addAccountBtnGlobal">＋ アカウントを追加</button>
            </div>
            <div class="setting-section">
                <h3>データのリセット</h3>
                <div class="reset-buttons">
                    <button class="btn-reset btn-reset-all" id="resetAllBtn">全データをリセット</button>
                </div>
            </div>
            <button class="btn-save" id="saveGlobalSettingsBtn">保存</button>
        </div>
    </div>

    <div class="modal" id="detailSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailModalTitle">アカウント設定</h2>
                <button class="close-btn" id="closeDetailSettingsBtn">×</button>
            </div>
            <div class="setting-section">
                <h3>アカウント名</h3>
                <div class="account-item">
                    <input type="text" id="detailAccountNameInput">
                </div>
            </div>
            <div class="setting-section">
                <h3>チャレンジ管理</h3>
                <div id="detailChallengeSettings"></div>
                <button class="btn-add" id="addChallengeInDetailModalBtn">＋ チャレンジを追加</button>
            </div>
            <button class="btn-save" id="saveDetailSettingsBtn">保存</button>
            <div class="setting-section">
                <h3>データのリセット</h3>
                <div class="reset-buttons">
                    <button class="btn-reset btn-reset-child" id="resetCurrentBtn">このアカウントをリセット</button>
                </div>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 id="confirmTitle">確認</h3>
            <p id="confirmMessage"></p>
            <div class="confirm-buttons">
                <button class="btn-confirm btn-cancel" id="cancelBtn">キャンセル</button>
                <button class="btn-confirm btn-confirm-action" id="confirmActionBtn">はい</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="celebration" id="celebration">
        <h2>おめでとう！🎉</h2>
        <p id="celebrationText"></p>
    </div>

    <script>
        const MAX_ACCOUNTS = 4;
        const STORAGE_KEY = 'challengeCoinData';
        
        let appData = { 
            accounts: [],
        };
        let currentAccountIndex = -1;
        let currentChallengeIndex = 0;
        let confirmCallback = null;

        const $ = id => document.getElementById(id);

        // データ保存・読み込み
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error('保存エラー:', e);
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data && Array.isArray(data.accounts)) {
                        data.accounts.forEach(acc => {
                            if (!acc.challenges) acc.challenges = [];
                            if (!acc.history) acc.history = [];
                            
                            // 旧データのマイグレーション処理 (coins -> challenges[0].coins)
                            if (typeof acc.coins === 'number') {
                                if (acc.challenges.length === 0) {
                                    acc.challenges.push({ name: 'お手伝い', value: 10, coins: 0, totalCoins: 0 });
                                }
                                if (acc.challenges.length > 0) {
                                    acc.challenges[0].coins = acc.coins;
                                    acc.challenges[0].totalCoins = acc.totalCoins || acc.coins;
                                }
                                delete acc.coins;
                                delete acc.totalCoins;
                                saveData(); // マイグレーション後に保存
                            }
                            
                            // チャレンジのデフォルト値設定
                            if (acc.challenges.length === 0) {
                                acc.challenges.push(getDefaultChallenge('お手伝い', 10));
                            }
                            
                            // データ構造の不足を補完
                            acc.challenges.forEach(chal => {
                                if (typeof chal.coins !== 'number') chal.coins = 0;
                                if (typeof chal.totalCoins !== 'number') chal.totalCoins = 0;
                            });
                        });
                        appData = data;
                    } else {
                        initializeData();
                    }
                } else {
                    initializeData();
                }
            } catch (e) {
                console.error('読み込みエラー:', e);
                initializeData();
            }
        }

        // 初期データ設定
        function getDefaultChallenge(name, value) {
            return { name: name, value: value, coins: 0, totalCoins: 0 };
        }

        function initializeData() {
            appData.accounts = [
                { name: 'アカウント1', challenges: [getDefaultChallenge('お手伝い', 10), getDefaultChallenge('チャレンジ2', 50)], rewardValue: 10, totalReward: 0 },
                { name: 'アカウント2', challenges: [getDefaultChallenge('お手伝い', 10), getDefaultChallenge('チャレンジ2', 50)], rewardValue: 10, totalReward: 0 },
            ];
            saveData();
        }

        // 画面切り替え
        function showScreen(screenId) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            $(screenId).classList.add('active');

            if (screenId === 'accountSelectScreen') {
                $('headerTitle').textContent = 'Challenge Coin!';
                $('backBtn').style.display = 'none';
                $('globalSettingsBtn').style.display = 'flex';
                $('detailSettingsBtn').style.display = 'none';
                $('challengeButtonsContainer').style.display = 'none';
                currentAccountIndex = -1;
                renderAccountList();
            } else if (screenId === 'accountDetailScreen') {
                const account = appData.accounts[currentAccountIndex];
                $('headerTitle').textContent = account.name;
                $('backBtn').style.display = 'flex';
                $('globalSettingsBtn').style.display = 'none';
                $('detailSettingsBtn').style.display = 'flex';
                $('challengeButtonsContainer').style.display = 'block';
                renderChallengeButtons();
                updateDetailScreen();
            }
        }

        // アカウントリストの描画
        function renderAccountList() {
            const accountList = $('accountList');
            accountList.innerHTML = '';
            appData.accounts.forEach((account, index) => {
                const totalCoins = account.challenges.reduce((sum, chal) => sum + chal.coins, 0);
                const card = document.createElement('div');
                card.className = 'account-card';
                card.dataset.index = index;
                card.innerHTML = `
                    <h3>${escapeHtml(account.name)}</h3>
                    <div class="coins-info">
                        <span class="coins-number-list">${totalCoins}</span>
                        <span>コイン</span>
                    </div>
                `;
                card.addEventListener('click', () => selectAccount(index));
                accountList.appendChild(card);
            });
            
            // アカウント追加ボタンの表示制御 (既にHTMLで配置されているため、ここでは制御しない)
            const addBtn = $('addAccountBtnSelect');
            if (appData.accounts.length >= MAX_ACCOUNTS) {
                addBtn.style.display = 'none';
            } else {
                addBtn.style.display = 'block';
            }
        }

        // アカウント選択
        function selectAccount(index) {
            currentAccountIndex = index;
            currentChallengeIndex = 0; // アカウント選択時は最初のチャレンジに設定
            showScreen('accountDetailScreen');
        }

        // チャレンジボタンの描画
        function renderChallengeButtons() {
            const wrapper = $('challengeButtonsWrapper');
            wrapper.innerHTML = '';
            const account = appData.accounts[currentAccountIndex];
            
            account.challenges.forEach((challenge, index) => {
                const button = document.createElement('button');
                button.className = 'challenge-button';
                if (index === currentChallengeIndex) {
                    button.classList.add('active');
                }
                button.textContent = escapeHtml(challenge.name);
                button.dataset.index = index;
                button.addEventListener('click', () => selectChallenge(index));
                wrapper.appendChild(button);
            });
            
            if (account.challenges.length === 0) {
                $('challengeButtonsContainer').style.display = 'none';
            } else {
                $('challengeButtonsContainer').style.display = 'block';
            }
        }

        // チャレンジ選択
        function selectChallenge(index) {
            if (currentChallengeIndex === index) return;
            currentChallengeIndex = index;
            renderChallengeButtons();
            updateDetailScreen();
        }

        // 詳細画面の更新
        function updateDetailScreen() {
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            
            // コイン表示
            $('currentCoins').textContent = challenge ? challenge.coins : 0;
            $('currentValue').textContent = challenge ? challenge.coins * account.rewardValue : 0;
            $('coinValueLabel').innerHTML = challenge ? `<strong>${challenge.value}</strong>コイン = <strong>${challenge.value * account.rewardValue}</strong>円` : '';
            $('totalCoins').textContent = challenge ? challenge.totalCoins : 0;
            $('totalCoinsLabel').textContent = challenge ? `${challenge.name}でのこれまでのコイン合計` : 'これまでのコイン合計';
            
            const isChallengeAvailable = !!challenge;

            // ボタン制御
            $('addCoinBtn').disabled = !isChallengeAvailable;
            $('removeCoinBtn').disabled = !isChallengeAvailable || challenge.coins <= 0;
            $('exchangeBtn').disabled = !isChallengeAvailable || challenge.coins < 1;
            $('exchangeInput').disabled = !isChallengeAvailable;
            $('exchangeInput').value = challenge && challenge.coins > 0 ? 1 : '';
            
            $('currentCoins').classList.toggle('disabled', !isChallengeAvailable);
            
            $('totalReward').textContent = `${account.totalReward}円`;
            renderHistory();
        }

        // コイン追加
        function addCoin() {
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            if (!challenge) return;

            challenge.coins++;
            challenge.totalCoins++;
            account.history.unshift({
                type: 'add',
                challengeName: challenge.name,
                coins: 1,
                date: new Date().toISOString()
            });
            saveData();
            updateDetailScreen();
            
            if (challenge.coins % 10 === 0) { // 10コインごとに祝福
                showCelebration(`やったね！${challenge.coins}コイン貯まったよ！`);
            }
        }

        // コイン削除
        function removeCoin() {
            const account = appData.accounts[currentAccountIndex];
            const challenge = account.challenges[currentChallengeIndex];
            if (!challenge || challenge.coins <= 0) return;

            challenge.coins--;
            account.history.unshift({
                type: 'remove',
                challengeName: challenge.name,
                coins: -1,
                date: new Date().toISOString()
            });
            saveData();
            updateDetailScreen();
        }

        // コイン交換処理
        function exchangeCoins() {
            const exchangeInput = $('exchangeInput');
            const count = parseInt(exchangeInput.value);
            
            const account = appData.accounts[currentAccountIndex];
            const totalCoins = account.challenges.reduce((sum, chal) => sum + chal.coins, 0);

            if (isNaN(count) || count <= 0) {
                alert('有効なコイン数を入力してください。');
                return;
            }
            
            if (count > totalCoins) {
                alert(`コインが不足しています。現在の合計: ${totalCoins}コイン`);
                return;
            }

            const reward = count * account.rewardValue;

            showConfirmModal(
                '交換の確認',
                `${count}コインを${reward}円のおこづかいと交換しますか？`,
                '交換する',
                'exchange-confirm',
                () => {
                    // コインを減らす（どのチャレンジから減らすかは今回は単純に均等に減らすか、あるいは実装を簡略化する）
                    // 今回は、合計コインを減らす形に修正。

                    let remainingToDeduct = count;
                    
                    // まずは現在のチャレンジから減らす
                    if (account.challenges[currentChallengeIndex]) {
                        const chal = account.challenges[currentChallengeIndex];
                        const deductFromCurrent = Math.min(remainingToDeduct, chal.coins);
                        chal.coins -= deductFromCurrent;
                        remainingToDeduct -= deductFromCurrent;
                    }

                    // 残りを他のチャレンジから順次減らす
                    for (let i = 0; i < account.challenges.length && remainingToDeduct > 0; i++) {
                        if (i === currentChallengeIndex) continue;
                        
                        const chal = account.challenges[i];
                        const deduct = Math.min(remainingToDeduct, chal.coins);
                        chal.coins -= deduct;
                        remainingToDeduct -= deduct;
                    }
                    
                    account.totalReward += reward;
                    
                    account.history.unshift({
                        type: 'exchange',
                        coins: -count,
                        reward: reward,
                        date: new Date().toISOString()
                    });
                    
                    saveData();
                    updateDetailScreen();
                    showCelebration(`${reward}円のおこづかいと交換したよ！✨`);
                }
            );
        }

        // 履歴表示のトグル
        function toggleHistory() {
            const historyDetails = $('historyDetails');
            const toggleText = $('historyToggleText');
            historyDetails.classList.toggle('show');
            toggleText.textContent = historyDetails.classList.contains('show') ? '閉じる' : 'くわしく見る';
        }

        // 履歴の描画
        function renderHistory() {
            const historyList = $('historyList');
            historyList.innerHTML = '';
            const account = appData.accounts[currentAccountIndex];

            if (account.history.length === 0) {
                historyList.innerHTML = '<div class="history-empty">まだ履歴はありません</div>';
                return;
            }

            account.history.forEach(item => {
                const date = new Date(item.date);
                const dateString = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                let description = '';
                let amountText = '';

                if (item.type === 'add') {
                    description = `${escapeHtml(item.challengeName)} 達成`;
                    amountText = `+${item.coins}コイン`;
                } else if (item.type === 'remove') {
                    description = `${escapeHtml(item.challengeName)} 修正`;
                    amountText = `${item.coins}コイン`;
                } else if (item.type === 'exchange') {
                    description = `おこづかい交換`;
                    amountText = `<span style="color: #4caf50;">${item.reward}円</span> (${item.coins}コイン)`;
                }

                const itemHtml = `
                    <div class="history-item">
                        <div>
                            <div class.history-description">${description}</div>
                            <div class="history-date">${dateString}</div>
                        </div>
                        <div class="history-reward-amount">${amountText}</div>
                    </div>
                `;
                historyList.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        
        // モーダル表示/非表示
        function showModal(modalId) {
            $(modalId).classList.add('show');
            $('overlay').classList.add('show');
        }

        function hideModal(modalId) {
            $(modalId).classList.remove('show');
            if (!$('globalSettingsModal').classList.contains('show') && !$('detailSettingsModal').classList.contains('show') && !$('confirmModal').classList.contains('show')) {
                $('overlay').classList.remove('show');
            }
        }
        
        // 全体設定モーダル
        function openGlobalSettings() {
            renderAccountSettings();
            showModal('globalSettingsModal');
        }

        function closeGlobalSettings() {
            hideModal('globalSettingsModal');
            renderAccountList(); // 変更があったかもしれないので再描画
        }

        // 詳細設定モーダル
        function openDetailSettings() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            
            $('detailModalTitle').textContent = `${account.name} の設定`;
            $('detailAccountNameInput').value = account.name;
            renderChallengeSettings(account);
            
            // リセットボタンのIDをアカウントインデックスで分けておく（イベントリスナー用）
            $('resetCurrentBtn').dataset.index = currentAccountIndex;

            showModal('detailSettingsModal');
        }

        function closeDetailSettings() {
            hideModal('detailSettingsModal');
            if (currentAccountIndex !== -1) {
                renderChallengeButtons(); // チャレンジが変更された可能性があるので更新
                updateDetailScreen(); // 画面を最新の状態に
            }
        }

        // アカウント設定の描画（全体設定モーダル内）
        function renderAccountSettings() {
            const accountSettings = $('accountSettings');
            accountSettings.innerHTML = '';
            
            appData.accounts.forEach((account, index) => {
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <input type="text" value="${escapeHtml(account.name)}" data-account-index="${index}" data-field="name">
                    <button class="btn-delete-account" data-delete-index="${index}">削除</button>
                `;
                accountSettings.appendChild(item);
            });
            
            document.querySelectorAll('#accountSettings .btn-delete-account').forEach(btn => {
                btn.addEventListener('click', event => deleteAccount(parseInt(event.currentTarget.dataset.deleteIndex)));
            });
            
            // アカウント追加ボタンの有効/無効
            const addBtn = $('addAccountBtnGlobal');
            addBtn.disabled = appData.accounts.length >= MAX_ACCOUNTS;
            addBtn.textContent = addBtn.disabled ? `アカウントを追加（最大${MAX_ACCOUNTS}人）` : '＋ アカウントを追加';
        }
        
        // チャレンジ設定の描画（詳細設定モーダル内）
        function renderChallengeSettings(account) {
            const challengeSettings = $('detailChallengeSettings');
            challengeSettings.innerHTML = '';
            
            account.challenges.forEach((challenge, index) => {
                const item = document.createElement('div');
                item.className = 'challenge-item';
                item.innerHTML = `
                    <div class="challenge-header">
                        <h4>チャレンジ #${index + 1}</h4>
                        <button class="btn-delete-challenge" data-challenge-index="${index}">削除</button>
                    </div>
                    <div class="challenge-inputs-group">
                        <label>チャレンジ名</label>
                        <input type="text" value="${escapeHtml(challenge.name)}" data-challenge-index="${index}" data-field="name">
                    </div>
                    <div class="challenge-inputs-group">
                        <label>獲得コイン数 (1回あたり)</label>
                        <div class="challenge-value-wrapper">
                            <div class="input-with-suffix">
                                <input type="number" min="1" value="${challenge.value}" data-challenge-index="${index}" data-field="value">
                                <span class="suffix">コイン</span>
                            </div>
                        </div>
                    </div>
                `;
                challengeSettings.appendChild(item);
            });
            
            document.querySelectorAll('#detailChallengeSettings .btn-delete-challenge').forEach(btn => {
                btn.addEventListener('click', event => deleteChallenge(parseInt(event.currentTarget.dataset.challengeIndex)));
            });
        }

        // 新しいアカウントの追加
        function addAccount() {
            if (appData.accounts.length >= MAX_ACCOUNTS) {
                alert(`アカウントは最大${MAX_ACCOUNTS}人までです。`);
                return;
            }
            
            const newName = `アカウント${appData.accounts.length + 1}`;
            appData.accounts.push({
                name: newName,
                challenges: [getDefaultChallenge('お手伝い', 10)],
                rewardValue: 10,
                totalReward: 0,
                history: []
            });
            
            saveData();
            // モーダルが開いていれば更新、そうでなければリストを更新
            if ($('globalSettingsModal').classList.contains('show')) {
                renderAccountSettings();
            } else {
                renderAccountList();
            }
        }

        // アカウントの削除
        function deleteAccount(index) {
            showConfirmModal(
                'アカウント削除の確認',
                `${appData.accounts[index].name} のデータを完全に削除します。よろしいですか？`,
                '削除する',
                'btn-confirm-action',
                () => {
                    appData.accounts.splice(index, 1);
                    saveData();
                    renderAccountSettings();
                    
                    // 現在表示中のアカウントが削除された場合、選択画面に戻る
                    if (currentAccountIndex === index || appData.accounts.length === 0) {
                        showScreen('accountSelectScreen');
                    }
                }
            );
        }
        
        // 新しいチャレンジの追加（詳細設定モーダル内）
        function addChallengeInDetailModal() {
            if (currentAccountIndex === -1) return;
            
            const account = appData.accounts[currentAccountIndex];
            const newIndex = account.challenges.length + 1;
            account.challenges.push(getDefaultChallenge(`チャレンジ${newIndex}`, 10));
            
            renderChallengeSettings(account);
        }

        // チャレンジの削除（詳細設定モーダル内）
        function deleteChallenge(index) {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            const challengeName = account.challenges[index].name;
            
            showConfirmModal(
                'チャレンジ削除の確認',
                `${challengeName} のデータを完全に削除します。よろしいですか？`,
                '削除する',
                'btn-confirm-action',
                () => {
                    account.challenges.splice(index, 1);
                    saveData();
                    renderChallengeSettings(account);
                    
                    // 現在選択中のチャレンジが削除された場合、選択をリセット
                    if (currentChallengeIndex >= account.challenges.length) {
                        currentChallengeIndex = account.challenges.length > 0 ? account.challenges.length - 1 : 0;
                    }
                    // 画面表示を更新するために設定モーダルを閉じるときに再描画する
                }
            );
        }

        // 全体設定の保存
        function saveGlobalSettings() {
            const accountInputs = document.querySelectorAll('#accountSettings input[type="text"]');
            
            accountInputs.forEach(input => {
                const index = parseInt(input.dataset.accountIndex);
                if (appData.accounts[index]) {
                    appData.accounts[index].name = input.value.trim() || `アカウント${index + 1}`;
                }
            });
            
            saveData();
            closeGlobalSettings();
        }

        // 詳細設定の保存
        function saveDetailSettings() {
            if (currentAccountIndex === -1) return;
            const account = appData.accounts[currentAccountIndex];
            
            // アカウント名の保存
            const newName = $('detailAccountNameInput').value.trim();
            account.name = newName || `アカウント${currentAccountIndex + 1}`;
            $('headerTitle').textContent = account.name; // ヘッダーも更新

            // チャレンジ設定の保存
            const challengeItems = document.querySelectorAll('#detailChallengeSettings .challenge-item');
            
            challengeItems.forEach(item => {
                const nameInput = item.querySelector('input[data-field="name"]');
                const valueInput = item.querySelector('input[data-field="value"]');
                const index = parseInt(nameInput.dataset.challengeIndex);
                
                if (account.challenges[index]) {
                    account.challenges[index].name = nameInput.value.trim() || `チャレンジ${index + 1}`;
                    const newValue = parseInt(valueInput.value);
                    account.challenges[index].value = isNaN(newValue) || newValue < 1 ? 1 : newValue;
                }
            });
            
            saveData();
            closeDetailSettings();
        }

        // 全データリセット
        function resetAllData() {
            showConfirmModal(
                '全データリセットの確認',
                '全てのアカウント情報、コイン、履歴を完全に削除します。本当によろしいですか？',
                'リセット',
                'btn-confirm-action',
                () => {
                    localStorage.removeItem(STORAGE_KEY);
                    initializeData();
                    closeGlobalSettings();
                    showScreen('accountSelectScreen');
                    currentAccountIndex = -1;
                }
            );
        }

        // 現在のアカウントをリセット
        function resetCurrentAccount(event) {
            const index = parseInt(event.currentTarget.dataset.index);
            const account = appData.accounts[index];
            
            showConfirmModal(
                `${account.name} のリセットの確認`,
                `アカウント ${account.name} のコインと履歴を全てリセットします。よろしいですか？`,
                'リセット',
                'btn-confirm-action',
                () => {
                    account.challenges.forEach(chal => {
                        chal.coins = 0;
                        chal.totalCoins = 0;
                    });
                    account.totalReward = 0;
                    account.history = [];
                    
                    saveData();
                    closeDetailSettings();
                    updateDetailScreen();
                }
            );
        }

        // 確認モーダル表示
        function showConfirmModal(title, message, confirmText, confirmClass, callback) {
            $('confirmTitle').textContent = title;
            $('confirmMessage').textContent = message;
            $('confirmActionBtn').textContent = confirmText;
            $('confirmActionBtn').className = `btn-confirm ${confirmClass}`;
            
            confirmCallback = () => {
                callback();
                hideModal('confirmModal');
            };
            
            $('confirmActionBtn').onclick = confirmCallback;
            $('cancelBtn').onclick = () => hideModal('confirmModal');
            
            showModal('confirmModal');
        }

        // 祝福アニメーション
        function showCelebration(message) {
            $('celebrationText').innerHTML = message;
            $('celebration').classList.add('show');
            $('overlay').classList.add('show');
            
            // 紙吹雪
            const confettiColors = ['#ff6b9d', '#ffc8d9', '#a8e6cf', '#dae7f8', '#fcb69f'];
            const confettiCount = 50;
            for (let i = 0; i < confettiCount; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                c.style.left = `${Math.random() * 100}vw`;
                c.style.animation = `confetti-fall ${2 + Math.random() * 3}s ease-in-out infinite`;
                c.style.animationDelay = `${-Math.random() * 3}s`;
                document.body.appendChild(c);

                setTimeout(() => c.remove(), 5000);
            }

            setTimeout(() => {
                $('celebration').classList.remove('show');
                if (!$('globalSettingsModal').classList.contains('show') && !$('detailSettingsModal').classList.contains('show') && !$('confirmModal').classList.contains('show')) {
                    $('overlay').classList.remove('show');
                }
                document.querySelectorAll('.confetti').forEach(c => c.remove());
            }, 3000);
        }
        
        // HTMLエスケープ処理（セキュリティ対策）
        function escapeHtml(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }


        // イベントリスナーの設定
        function setupEventListeners() {
            $('globalSettingsBtn').addEventListener('click', openGlobalSettings);
            $('closeGlobalSettingsBtn').addEventListener('click', closeGlobalSettings);
            $('saveGlobalSettingsBtn').addEventListener('click', saveGlobalSettings);
            
            // 修正: グローバル設定モーダル内の追加ボタンのIDを修正
            $('addAccountBtnGlobal').addEventListener('click', addAccount);
            
            // 修正: アカウント選択画面内の追加ボタンのイベントリスナーを追加
            $('addAccountBtnSelect').addEventListener('click', addAccount);

            $('resetAllBtn').addEventListener('click', resetAllData);
            
            $('backBtn').addEventListener('click', () => showScreen('accountSelectScreen'));
            $('detailSettingsBtn').addEventListener('click', openDetailSettings);
            
            $('closeDetailSettingsBtn').addEventListener('click', closeDetailSettings);
            $('saveDetailSettingsBtn').addEventListener('click', saveDetailSettings);
            $('addChallengeInDetailModalBtn').addEventListener('click', addChallengeInDetailModal);
            $('resetCurrentBtn').addEventListener('click', resetCurrentAccount);
            
            $('addCoinBtn').addEventListener('click', addCoin);
            $('removeCoinBtn').addEventListener('click', removeCoin);
            
            $('exchangeBtn').addEventListener('click', exchangeCoins);
            $('exchangeInput').addEventListener('input', () => {
                const input = $('exchangeInput');
                const account = appData.accounts[currentAccountIndex];
                const totalCoins = account ? account.challenges.reduce((sum, chal) => sum + chal.coins, 0) : 0;

                if (parseInt(input.value) > totalCoins) {
                    input.value = totalCoins > 0 ? totalCoins : 1;
                }
                if (parseInt(input.value) < 1) {
                    input.value = 1;
                }
                $('exchangeBtn').disabled = totalCoins < 1 || parseInt(input.value) <= 0;
            });

            $('toggleHistoryBtn').addEventListener('click', toggleHistory);
        }

        // アプリケーション起動
        loadData();
        setupEventListeners();
        if (appData.accounts.length > 0) {
            showScreen('accountSelectScreen');
        } else {
            // アカウントが0の場合でも、初期アカウントリストを表示するために、一度設定モーダルを開いて追加を促すなど工夫が必要だが、ここではシンプルに初期画面を表示
            showScreen('accountSelectScreen');
        }
    </script>
</body>
</html>
